<!DOCTYPE html>
<body>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BF6 Mastery Loadout Tracker</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #05090d;
      --panel: #0f161c;
      --panel-border: #1c252f;
      --accent: #00e5ff; /* BF6-style cyan */
      --accent-soft: rgba(0, 229, 255, 0.16);
      --ally: #00d1ff; /* Ally blue (refined) */
      --ally-soft: rgba(0, 209, 255, 0.18);
      --enemy: #ff3b3b; /* Enemy red (refined) */
      --enemy-soft: rgba(255, 59, 59, 0.2);
      --text: #f5f8fa;
      --text-muted: #95a3b1;
      --danger: #ff6b6b;
      --card-padding: 12px;
      --indent: 36px;
      --card-radius: 7px;
      --transition: 160ms ease;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
      --font: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --ui-scale: 1; /* 1.0 = 100% */
      --ui-scale-pct: 100%; /* fill for UI scale track */
    }

    * {
      box-sizing: border-box;
    }

    /* Ensure hidden elements do not render */
    [hidden] { display: none !important; }

    body {
      margin: 0;
      background: radial-gradient(1000px 600px at 80% -100px, rgba(0, 229, 255, 0.12), transparent 60%),
        linear-gradient(180deg, rgba(10, 18, 25, 0.9) 0%, rgba(5, 9, 13, 0.96) 60%, rgba(5, 9, 13, 1) 100%),
        var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .app {
      width: min(1000px, 100%);
      background: rgba(8, 12, 16, 0.55);
      border: 1px solid rgba(120, 160, 180, 0.14);
      border-radius: 16px;
      padding: 24px 28px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      gap: 24px;
      position: relative;
    }

    .app::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.08;
      background-image: 
        repeating-linear-gradient(90deg, rgba(180, 200, 220, 0.12) 0 1px, transparent 1px 24px),
        repeating-linear-gradient(0deg, rgba(180, 200, 220, 0.10) 0 1px, transparent 1px 24px);
      mask-image: radial-gradient(80% 60% at 50% 10%, black, transparent 80%);
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .page-title {
      font-size: clamp(24px, 4vw, 32px);
      font-weight: 700;
      letter-spacing: 0.02em;
      margin: 0;
    }

    .page-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0;
      max-width: 660px;
    }

    .weapon-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .weapon-card {
      background: rgba(10, 16, 21, 0.6);
      border-radius: 14px;
      border: 1px solid rgba(80, 120, 140, 0.18);
      display: flex;
      flex-direction: column;
      padding: 10px 12px;
      gap: 10px;
      transition: box-shadow var(--transition), border-color var(--transition), background var(--transition);
      position: relative;
      outline: none;
    }

    .weapon-card::before {
      content: "";
      position: absolute;
      left: 10px;
      right: 10px;
      top: 0;
      height: 2px;
      border-radius: 2px;
      background: linear-gradient(90deg, transparent, rgba(0, 229, 255, 0.55), transparent);
      pointer-events: none;
    }

    .weapon-card:focus-visible {
      box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.6);
    }

    .weapon-card.dragging {
      opacity: 0.8;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6);
      border-color: rgba(0, 229, 255, 0.35);
      background: rgba(10, 16, 21, 0.7);
      will-change: background, box-shadow;
    }

    .weapon-card:hover {
      border-color: rgba(0, 229, 255, 0.25);
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.45);
      background: rgba(10, 16, 21, 0.62);
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; }
    }

    .weapon-card.favorite {
      border-color: rgba(0, 229, 255, 0.55);
      box-shadow: 0 0 0 1px rgba(0, 229, 255, 0.25), 0 16px 36px rgba(0, 229, 255, 0.14);
      background: rgba(10, 16, 21, 0.66);
    }

    .weapon-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      cursor: grab;
      user-select: none;
      -webkit-user-select: none;
    }

    .weapon-header:active { cursor: grabbing; }

    .weapon-header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1 1 auto;
      min-width: 160px;
      position: relative;
      user-select: none;
      -webkit-user-select: none;
    }

    .weapon-name {
      font-size: clamp(20px, 3.6vw, 26px);
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .weapon-image-wrap {
      flex: 0 0 auto;
      margin-left: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 110px;
      min-height: 38px;
    }

    .weapon-image {
      max-height: 38px;
      width: auto;
      border-radius: 6px;
      border: 1px solid rgba(60, 74, 85, 0.55);
      background: rgba(18, 26, 32, 0.88);
      object-fit: contain;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      display: block;
    }

    .weapon-image-ph {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      min-height: 38px;
      min-width: 110px;
      border-radius: 6px;
      border: 1px dotted rgba(120, 140, 156, 0.9);
      color: var(--text-muted);
      font-size: 12px;
      letter-spacing: 0.04em;
      background: rgba(18, 26, 32, 0.6);
      text-transform: none;
      user-select: none;
      -webkit-user-select: none;
    }

    .weapon-image-wrap.placeholder .weapon-image { display: none; }
    .weapon-image-wrap:not(.placeholder) .weapon-image-ph { display: none; }

    

    /* Meta chips under the weapon name */
    .weapon-meta-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
      flex-wrap: wrap;
    }

    .meta-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border: 1px solid rgba(60, 74, 85, 0.6);
      background: rgba(18, 26, 32, 0.88);
      color: var(--text);
      user-select: none;
      -webkit-user-select: none;
    }

    .meta-chip.type-chip {
      background: linear-gradient(135deg, rgba(0,229,255,0.18), rgba(0,229,255,0.08));
      border-color: rgba(0,229,255,0.45);
      color: #e9fbff;
      text-shadow: 0 0 6px rgba(0,229,255,0.28);
    }

    .meta-chip.rank-m { background: linear-gradient(135deg, #f1c40f, #d4a017); border-color: rgba(241,196,15,0.65); color: #132018; }
    .meta-chip.rank-a { background: linear-gradient(135deg, #00e5ff, #3aa6ff); border-color: rgba(0,229,255,0.55); color: #0a1620; }
    .meta-chip.rank-b { background: linear-gradient(135deg, #14d672, #0fb862); border-color: rgba(20,214,114,0.55); color: #0c1d16; }
    .meta-chip.rank-c { background: linear-gradient(135deg, #ffb15a, #ff8a3a); border-color: rgba(255,165,80,0.6); color: #23160c; }
    .meta-chip.rank-d { background: linear-gradient(135deg, #ff6b6b, #ff4444); border-color: rgba(255,107,107,0.6); color: #2a0f12; }
    .meta-chip.rank-unranked { background: linear-gradient(135deg, #7d5fff, #5a3dff); border-color: rgba(125,95,255,0.55); color: #f2f0ff; }

    .meta-chip.range-1 { background: linear-gradient(135deg, #f1c40f, #d4a017); border-color: rgba(241,196,15,0.65); color: #132018; }
    .meta-chip.range-2 { background: linear-gradient(135deg, #bdc3c7, #95a5a6); border-color: rgba(189,195,199,0.6); color: #141b1e; }
    .meta-chip.range-3 { background: linear-gradient(135deg, #cd7f32, #b9732c); border-color: rgba(205,127,50,0.65); color: #210f08; }
    .meta-chip.range-4 { background: linear-gradient(135deg, #5b7a8e, #3f5566); border-color: rgba(91,122,142,0.6); color: #e6eef5; }
    .meta-chip.range-unranked { background: linear-gradient(135deg, #7d5fff, #5a3dff); border-color: rgba(125,95,255,0.55); color: #f2f0ff; }

    .level-pill {
      background: rgba(0, 229, 255, 0.12);
      color: var(--accent);
      border: 1px solid rgba(0, 229, 255, 0.35);
      border-radius: 999px;
      padding: 5px 12px;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      white-space: nowrap;
    }

    /* Header chevron chip */
    .chevron-toggle {
      position: absolute;
      top: -2px;
      right: -2px;
      border: 1px solid rgba(60, 74, 85, 0.55);
      background: rgba(18, 26, 32, 0.88);
      color: var(--text);
      border-radius: 8px;
      padding: 2px 6px;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      transform: rotate(90deg);
      transition: transform var(--transition);
      user-select: none;
      -webkit-user-select: none;
    }

    .weapon-card.collapsed .chevron-toggle {
      transform: rotate(0deg);
    }

    /* Header condensed controls row */
    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .header-level {
      color: #00e5ff;
      text-shadow: 0 0 8px rgba(0, 229, 255, 0.35);
      font-weight: 700;
      letter-spacing: 0.08em;
    }

    .header-sep { opacity: 0.6; }

    .header-controls .progress {
      width: min(260px, 40vw);
    }

    /* Hide header level pill; no collapsed indicator */
    .weapon-card .level-pill { display: none !important; }

    .favorite-toggle,
    .collapse-toggle,
    .collapse-box,
    .drag-handle {
      border: 1px solid rgba(60, 74, 85, 0.55);
      background: rgba(18, 26, 32, 0.88);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background var(--transition), border-color var(--transition), color var(--transition);
    }

    .drag-handle { cursor: grab; display: none !important; }

    /* Hide legacy UI controls/labels when using header row */
    .collapse-toggle { display: none !important; }
    .favorite-toggle .favorite-text { display: none !important; }
    .weapon-body .level-controls { display: none !important; }
    .weapon-body .level-display { display: none !important; }
    .attachments-header .ap-total { display: none !important; }

    .drag-handle:active { cursor: grabbing; }

    .favorite-toggle:hover,
    .collapse-toggle:hover,
    .collapse-box:hover,
    .drag-handle:hover {
      background: rgba(0, 229, 255, 0.12);
      border-color: rgba(0, 229, 255, 0.35);
    }

    .favorite-toggle[aria-pressed="true"] {
      background: rgba(0, 229, 255, 0.18);
      border-color: rgba(0, 229, 255, 0.5);
      color: var(--accent);
    }

    /* Square icon-only controls */
    .favorite-toggle,
    .collapse-box {
      width: 34px;
      height: 34px;
      padding: 0;
      font-size: 18px;
      line-height: 1;
      text-transform: none;
    }

    .control-stack {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
    }

    .weapon-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .weapon-card.collapsed .weapon-body {
      display: none;
    }

    /* Left floating weapon nav */
    .side-nav { 
      position: fixed; 
      top: 30px !important; 
      left: 8px; 
      z-index: 20; 
      padding: 8px; 
      border: 1px solid rgba(60,74,85,.55); 
      background: rgba(18,26,32,.88); 
      border-radius: 10px; 
      box-shadow: 0 8px 24px rgba(0,0,0,.35); 
      width: 240px; 
      max-height: calc(100vh - 120px); 
      overflow-y: auto; 
      overflow-x: hidden; 
      overscroll-behavior: contain; 
      scrollbar-width: thin; 
    }

    
    /* Hide the nav UI until populated to avoid a stray shape */
    .side-nav:not(.nav-ready) { visibility: hidden; pointer-events: none; }
.side-nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .side-nav-item {
      border: 1px solid rgba(60, 74, 85, 0.55);
      background: rgba(10, 16, 21, 0.7);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition);
      user-select: none;
      -webkit-user-select: none;
    }

.side-nav-item:hover { background: rgba(0, 229, 255, 0.12); border-color: rgba(0, 229, 255, 0.35); }
.side-nav-name { flex: 1 1 auto; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.side-nav-type { color: var(--text-muted); font-size: 11px; letter-spacing: 0.04em; }
.side-nav-fav { color: #00e5ff; font-size: 14px; line-height: 1; }

/* Hide horizontal scrollbar in WebKit for side nav */
.side-nav::-webkit-scrollbar:horizontal { height: 0; }

@media (max-width: 900px) {
  .side-nav { display: none; }
}

    /* UI Scale panel (sits above the side nav) */
    .ui-scale-panel {
      position: fixed;
      top: 8px;
      right: 8px;
      z-index: 25;
      width: 240px;
      padding: 8px 10px;
      border: 1px solid rgba(60,74,85,.55);
      background: rgba(18,26,32,.88);
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .ui-scale-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      letter-spacing: 0.04em;
      color: var(--text);
    }

    .ui-scale-text { color: var(--text-muted); }
    .ui-scale-value { font-weight: 700; color: var(--accent); text-shadow: 0 0 8px rgba(0, 229, 255, 0.35); }

    /* Match level bar exactly */
    .ui-scale-panel .progress { width: 100%; }

    /* Scale only the main app; leave side nav unscaled for alignment */
    .app { transform: scale(var(--ui-scale)); transform-origin: top center; }

    .level-controls {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .level-button {
      width: 36px;
      aspect-ratio: 1;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: var(--panel);
      color: var(--text);
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--transition), border-color var(--transition), background var(--transition);
    }

    .level-button:hover:not(:disabled) {
      transform: translateY(-1px);
      border-color: var(--accent);
      background: rgba(0, 229, 255, 0.08);
    }

    .level-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .level-display {
      font-size: 13px;
      color: var(--text-muted);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .progress {
      position: relative;
      height: 12px;
      border-radius: 999px;
      background: rgba(22, 32, 40, 0.9);
      border: 1px solid rgba(60, 74, 85, 0.6);
      overflow: hidden;
      cursor: pointer;
      /* Enable smooth dragging on touch/pointer devices */
      touch-action: none;
      display: grid;
      grid-template-columns: repeat(var(--max-level), 1fr);
    }

    .progress .segment {
      background: transparent;
      position: relative;
    }

    .progress .segment::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 229, 255, 0.32);
      opacity: 0;
      transition: opacity var(--transition);
    }

    .progress .segment.active::after {
      opacity: 1;
    }

    .progress .knob {
      position: absolute;
      top: 50%;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.12), 0 0 0 3px rgba(0, 229, 255, 0.25);
      transform: translate(-50%, -50%);
      transition: left 120ms ease;
      pointer-events: none;
    }

    .weapon-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(240px, 280px);
      gap: 22px;
      padding-right: 12px;
      align-items: flex-start;
    }

    .side-column {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-self: stretch;
      width: min(290px);
    }

    .attachments-panel {
      background: rgba(12, 18, 24, 0.55);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      border-radius: 14px;
      border: 1px solid rgba(80, 120, 140, 0.18);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      overflow: hidden;
      flex: 1;
    }

    .attachments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(54, 69, 82, 0.35);
      padding-bottom: 12px;
    }

    .attachments-header h2 {
      margin: 0;
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(160, 178, 192, 0.9);
    }

    .ap-total {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .ap-readout {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(177, 191, 203, 0.95);
      white-space: nowrap;
    }

    .ap-readout .ap-value {
      color: var(--text);
    }

    .ap-readout .ap-max {
      color: rgba(132, 145, 156, 0.75);
    }

    .ap-meter {
      display: flex;
      gap: 3px;
      align-items: center;
    }

    .ap-cell {
      position: relative;
      width: 16px;
      height: 16px;
      border-radius: 4px;
      background: rgba(15, 22, 28, 0.92);
      border: 1px solid rgba(41, 54, 65, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transition), border-color var(--transition), opacity var(--transition);
      overflow: hidden;
    }

    .ap-cell .ap-icon {
      position: relative;
      width: 12px;
      height: 12px;
      display: block;
    }

    .ap-cell .ap-icon img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: grayscale(1) brightness(0.55);
      opacity: 0.4;
      pointer-events: none;
    }

    .ap-cell.half .ap-icon img,
    .ap-cell.full .ap-icon img {
      filter: grayscale(0.2) brightness(0.9);
      opacity: 0.75;
    }

    .ap-cell.full .ap-icon img {
      opacity: 0.95;
      filter: grayscale(0) brightness(1.05);
    }

    .ap-cell .ap-fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(0, 229, 255, 0.9), rgba(0, 229, 255, 0.65));
      opacity: 0;
      transition: opacity var(--transition);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .ap-cell .ap-fill.first {
      clip-path: polygon(0 0, 100% 0, 0 100%);
    }

    .ap-cell .ap-fill.second {
      clip-path: polygon(100% 0, 100% 100%, 0 100%);
    }

    .ap-cell.half {
      background: rgba(22, 30, 37, 0.95);
      border-color: rgba(71, 89, 103, 0.85);
    }

    .ap-cell.half .ap-fill.first {
      opacity: 0.9;
    }

    .ap-cell.full {
      background: rgba(28, 36, 43, 0.95);
      border-color: rgba(96, 110, 122, 0.9);
    }

    .ap-cell.full .ap-fill {
      opacity: 0.95;
    }

    .slots {
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
    }

    .slot-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }

    .slot-label {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .slot-card {
      position: relative;
      background: rgba(16, 24, 30, 0.92);
      border-radius: var(--card-radius);
      border: 1px solid rgba(45, 58, 70, 0.7);
      padding: var(--card-padding);
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: border-color var(--transition), box-shadow var(--transition), background var(--transition), transform var(--transition);
    }

    .slot-card.changed {
      /* Fallbacks for browsers without color-mix */
      border-color: rgba(0, 209, 255, 0.70);
      box-shadow: inset 0 0 0 1px rgba(0, 209, 255, 0.35), 0 10px 28px rgba(0, 209, 255, 0.18);
      /* Preferred modern blend */
      border-color: color-mix(in oklab, var(--ally) 70%, transparent);
      box-shadow: inset 0 0 0 1px color-mix(in oklab, var(--ally) 35%, transparent), 0 10px 28px color-mix(in oklab, var(--ally) 18%, transparent);
      background: rgba(12, 26, 32, 0.92);
    }

    .slot-card.old {
      background: rgba(10, 16, 21, 0.85);
      border-color: rgba(34, 43, 51, 0.9);
      color: var(--text-muted);
    }

    .slot-card.old .card-title {
      text-decoration: line-through;
      text-decoration-color: rgba(255, 255, 255, 0.4);
    }

    .slot-card.removed {
      /* Fallback */
      border-color: rgba(255, 59, 59, 0.60);
      /* Preferred */
      border-color: color-mix(in oklab, var(--enemy) 60%, transparent);
      background: rgba(28, 12, 14, 0.9);
    }

    .slot-card.removed .card-level {
      /* Fallbacks */
      border-color: rgba(255, 59, 59, 0.5);
      color: rgba(255, 120, 120, 0.9);
      /* Preferred */
      border-color: color-mix(in oklab, var(--enemy) 50%, transparent);
      color: color-mix(in oklab, var(--enemy) 65%, white 35%);
    }

    .slot-card.empty {
      font-style: italic;
      color: var(--text-muted);
      border-style: dashed;
    }

    .slot-card.indented {
      margin-left: var(--indent);
    }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .card-info {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .card-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 10px;
      text-transform: uppercase;
      color: rgba(177, 191, 203, 0.78);
    }

    .card-meta .meta-type {
      letter-spacing: 0.18em;
    }

    .card-meta .meta-separator {
      opacity: 0.6;
      letter-spacing: 0.18em;
    }

    .ap-inline {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.08em;
      color: rgba(177, 191, 203, 0.9);
      text-transform: uppercase;
    }

    .ap-inline img {
      width: 9px;
      height: 9px;
      filter: grayscale(1) brightness(0.8);
      opacity: 0.85;
    }

    .slot-card.old .ap-inline {
      opacity: 0.7;
    }

    .card-level {
      margin-left: auto;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(78, 95, 110, 0.6);
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(177, 191, 203, 0.86);
      white-space: nowrap;
    }

    .slot-card.changed .card-level {
      border-color: rgba(0, 229, 255, 0.6);
      background: rgba(0, 229, 255, 0.12);
      color: var(--accent);
    }

    .slot-card.old .card-level {
      border-color: rgba(78, 95, 110, 0.35);
      color: rgba(120, 136, 151, 0.9);
    }

    .card-description {
      font-size: 12px;
      color: rgba(173, 187, 198, 0.85);
      line-height: 1.45;
    }

    .arrow-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .arrow-svg {
      position: absolute;
      overflow: visible;
    }

    .changes-panel {
      background: rgba(16, 24, 30, 0.92);
      border-radius: 12px;
      border: 1px solid rgba(45, 58, 70, 0.7);
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .changes-panel h3 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    /* Recommended build panel matches changes styling */
    .recommended-panel {
      background: rgba(16, 24, 30, 0.92);
      border-radius: 12px;
      border: 1px solid rgba(45, 58, 70, 0.7);
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .recommended-panel h3 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .recommended-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .recommended-empty {
      padding: 12px;
      border-radius: 10px;
      border: 1px dashed rgba(60, 74, 85, 0.6);
      color: rgba(148, 161, 173, 0.85);
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      text-align: center;
    }

    .change-row {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .change-heading {
      font-size: 12px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: rgba(177, 191, 203, 0.9);
    }

    .change-detail {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: rgba(148, 161, 173, 0.85);
    }

    .change-detail .change-next {
      color: var(--accent);
    }

    .changes-empty {
      padding: 12px;
      border-radius: 10px;
      border: 1px dashed rgba(60, 74, 85, 0.6);
      color: rgba(148, 161, 173, 0.85);
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      text-align: center;
    }

    @media (max-width: 960px) {
      .weapon-layout {
        grid-template-columns: 1fr;
      }

      .side-column {
        width: 100%;
      }
    }

    @media (max-width: 720px) {
      body {
        padding: 16px;
      }

      .app {
        padding: 20px;
      }
    }
  /* Enhanced chip visuals (vibrant + glow) */
    .meta-chip.type-chip {
      background: linear-gradient(135deg, rgba(0,229,255,0.28), rgba(0,229,255,0.10));
      border-color: rgba(0,229,255,0.65);
      color: #e9fbff;
      text-shadow: 0 0 8px rgba(0,229,255,0.45);
      box-shadow: 0 0 12px rgba(0,229,255,0.25), inset 0 0 6px rgba(0,229,255,0.25);
    }

    .meta-chip.rank-m {
      background: linear-gradient(135deg, #ffe57a, #f1c40f);
      border-color: rgba(241,196,15,0.85);
      color: #1b1a10;
      text-shadow: 0 0 8px rgba(241,196,15,0.55);
      box-shadow: 0 0 16px rgba(241,196,15,0.45), inset 0 0 8px rgba(241,196,15,0.35);
    }
    .meta-chip.rank-a {
      background: linear-gradient(135deg, #4dd2ff, #00bfff);
      border-color: rgba(0,191,255,0.8);
      color: #08131a;
      text-shadow: 0 0 7px rgba(0,191,255,0.45);
      box-shadow: 0 0 14px rgba(0,191,255,0.35), inset 0 0 7px rgba(0,191,255,0.28);
    }
    .meta-chip.rank-b {
      background: linear-gradient(135deg, #2ee58d, #14d672);
      border-color: rgba(20,214,114,0.75);
      color: #0b1712;
      text-shadow: 0 0 6px rgba(20,214,114,0.35);
      box-shadow: 0 0 12px rgba(20,214,114,0.28), inset 0 0 6px rgba(20,214,114,0.22);
    }
    .meta-chip.rank-c {
      background: linear-gradient(135deg, #ffc27a, #ff9b4d);
      border-color: rgba(255,155,77,0.7);
      color: #24150a;
      text-shadow: 0 0 5px rgba(255,155,77,0.28);
      box-shadow: 0 0 10px rgba(255,155,77,0.22), inset 0 0 5px rgba(255,155,77,0.18);
    }
    .meta-chip.rank-d {
      background: linear-gradient(135deg, #ff8b8b, #ff5c5c);
      border-color: rgba(255,92,92,0.65);
      color: #2b0f12;
      text-shadow: 0 0 4px rgba(255,92,92,0.22);
      box-shadow: 0 0 9px rgba(255,92,92,0.18), inset 0 0 4px rgba(255,92,92,0.15);
    }
    .meta-chip.rank-unranked {
      background: linear-gradient(135deg, #8d78ff, #6a4dff);
      border-color: rgba(125,95,255,0.7);
      color: #f5f3ff;
      text-shadow: 0 0 6px rgba(125,95,255,0.35);
      box-shadow: 0 0 12px rgba(125,95,255,0.25), inset 0 0 6px rgba(125,95,255,0.22);
    }

    /* Type rating (TR) chips: #1 gold, #2 silver, #3 bronze, #4 dull blue */
    .meta-chip.range-1 {
      background: linear-gradient(135deg, #ffe57a, #f1c40f);
      border-color: rgba(241,196,15,0.85);
      color: #1b1a10;
      text-shadow: 0 0 8px rgba(241,196,15,0.55);
      box-shadow: 0 0 16px rgba(241,196,15,0.45), inset 0 0 8px rgba(241,196,15,0.35);
    }
    .meta-chip.range-2 {
      background: linear-gradient(135deg, #edf1f4, #bfc7cc);
      border-color: rgba(191,199,204,0.85);
      color: #101519;
      text-shadow: 0 0 7px rgba(191,199,204,0.45);
      box-shadow: 0 0 14px rgba(191,199,204,0.35), inset 0 0 7px rgba(191,199,204,0.28);
    }
    .meta-chip.range-3 {
      background: linear-gradient(135deg, #f0a561, #cd7f32);
      border-color: rgba(205,127,50,0.8);
      color: #211108;
      text-shadow: 0 0 6px rgba(205,127,50,0.35);
      box-shadow: 0 0 12px rgba(205,127,50,0.28), inset 0 0 6px rgba(205,127,50,0.22);
    }
    .meta-chip.range-4 {
      background: linear-gradient(135deg, #6d8aa0, #4a6273);
      border-color: rgba(91,122,142,0.75);
      color: #e9f2f9;
      text-shadow: 0 0 5px rgba(91,122,142,0.28);
      box-shadow: 0 0 10px rgba(91,122,142,0.22), inset 0 0 5px rgba(91,122,142,0.18);
    }
    .meta-chip.range-unranked {
      background: linear-gradient(135deg, #8d78ff, #6a4dff);
      border-color: rgba(125,95,255,0.7);
      color: #f5f3ff;
      text-shadow: 0 0 6px rgba(125,95,255,0.35);
      box-shadow: 0 0 12px rgba(125,95,255,0.25), inset 0 0 6px rgba(125,95,255,0.22);
    }
</style>
</style>
</head>
<body>
  <div class="ui-scale-panel" id="uiScalePanel" role="group" aria-label="UI Scale">
    <div class="ui-scale-row">
      <span class="ui-scale-text">UI Scale</span>
      <span class="ui-scale-value" id="uiScaleValue">100%</span>
    </div>
    <div class="progress" id="uiScaleProgress" role="slider" aria-label="UI scale" aria-valuemin="50" aria-valuemax="200" aria-valuenow="100">
      <div class="knob"></div>
    </div>
  </div>
  <nav id="weaponNav" class="side-nav" aria-label="Weapons"></nav>
  <div class="app">
    <header class="page-header">
      <h1 class="page-title">Mastery Loadout Tracker</h1>
      <p class="page-subtitle">Track multiple mastery weapons, compare their attachment unlocks, and keep your favorites pinned for fast reference.</p>
    </header>
    <div class="weapon-list" id="weaponList"></div>
  </div>

  <template id="weaponTemplate">
    <section class="weapon-card" tabindex="0">
      <div class="weapon-header" draggable="true">
        <button class="drag-handle" type="button" title="Drag to reorder" aria-label="Drag to reorder" draggable="true">
          <span aria-hidden="true">&#9776;</span>
        </button>
        <div class="control-stack">
          <button class="collapse-box" type="button" aria-label="Toggle collapse" aria-expanded="true">&#9662;</button>
          <button class="favorite-toggle" type="button" aria-pressed="false" title="Toggle favorite">
            <span aria-hidden="true">&#9734;</span>
          </button>
        </div>
        <div class="weapon-header-text" tabindex="0" role="button" aria-label="Toggle collapse" aria-expanded="true">
          <div class="weapon-name"></div>          <div class="weapon-meta-row"><span class="meta-chip type-chip"></span><span class="meta-chip rank-chip"></span><span class="meta-chip range-chip"></span></div>
          
          <div class="header-controls">
            <span class="header-level" aria-live="polite">LEVEL 1</span>
            <span class="header-sep" aria-hidden="true">&bull;</span>
            <button class="level-button level-down" type="button" aria-label="Decrease level">-</button>
            <div class="progress" role="slider" aria-valuemin="1" aria-valuemax="40" aria-valuenow="1">
              <div class="knob"></div>
            </div>
            <button class="level-button level-up" type="button" aria-label="Increase level">+</button>
            <div class="ap-inline">
              <div class="ap-meter"></div>
              <div class="ap-readout">
                <span class="ap-value">0</span>
                <span class="ap-max"></span>
              </div>
            </div>
          </div>
        </div>
        <div class="weapon-image-wrap placeholder">
          <img class="weapon-image" alt="" loading="lazy" draggable="false" />
          <div class="weapon-image-ph">No Image Yet</div>
        </div>
        <div class="level-pill"></div>
        <button class="collapse-toggle" type="button" aria-expanded="true">Hide</button>
      </div>
      <div class="weapon-body">
        <div class="level-controls">
          <button class="level-button level-down" type="button" aria-label="Decrease level">-</button>
          <div class="progress" role="slider" aria-valuemin="1" aria-valuemax="40" aria-valuenow="1">
            <div class="knob"></div>
          </div>
          <button class="level-button level-up" type="button" aria-label="Increase level">+</button>
        </div>
        <div class="level-display"></div>
        <div class="weapon-layout">
          <section class="attachments-panel">
            <div class="attachments-header">
              <h2>Attachments</h2>
              <div class="ap-total">
                <div class="ap-meter"></div>
                <div class="ap-readout">
                  <span class="ap-value">0</span>
                  <span class="ap-max"></span>
                </div>
              </div>
            </div>
            <div class="slots"></div>
          </section>
          <aside class="side-column">
            <section class="changes-panel">
              <h3>Changes at this Level</h3>
              <div class="changes-empty">No changes unlocked at this level.</div>
            </section>
            <section class="recommended-panel" hidden>
              <h3>Recommended Build</h3>
              <div class="ap-total ap-total-recommended">
                <div class="ap-meter"></div>
                <div class="ap-readout">
                  <span class="ap-value">0</span>
                  <span class="ap-max"></span>
                </div>
              </div>
              <div class="recommended-list"></div>
            </section>
          </aside>
        </div>
      </div>
    </section>
  </template>
  <script>
    const AP_ICON = 'https://static.wikia.nocookie.net/battlefield/images/0/06/Battlefield_6_Attachment_Point_Icon.png';
    const INDENT = 36;
    const CARD_PAD = 12;
    const ARROW_STROKE = 3;

    document.documentElement.style.setProperty('--indent', `${INDENT}px`);
    document.documentElement.style.setProperty('--card-padding', `${CARD_PAD}px`);

    const toUpperSafe = (value) => (typeof value === 'string' ? value.toUpperCase() : value);

    function normalizeReplaced(replaced) {
      if (!replaced) return [];
      const array = Array.isArray(replaced) ? replaced : [replaced];
      return array
        .map((entry) => {
          if (typeof entry === 'string') {
            return { name: toUpperSafe(entry) };
          }
          if (entry && typeof entry === 'object') {
            const normalized = { ...entry };
            if (normalized.name) normalized.name = toUpperSafe(normalized.name);
            if (normalized.type) normalized.type = toUpperSafe(normalized.type);
            return normalized;
          }
          return null;
        })
        .filter(Boolean);
    }

    function normalizeEntry(payload, unlockLevel) {
      if (!payload || typeof payload !== 'object') return null;
      const entry = { ...payload };
      if (unlockLevel !== undefined) {
        entry.unlockLevel = unlockLevel;
      }
      if (entry.name) entry.name = toUpperSafe(entry.name);
      if (entry.type) entry.type = toUpperSafe(entry.type);
      if (entry.replaced) {
        entry.replaced = normalizeReplaced(entry.replaced);
      }
      return entry;
    }

    const storage = (() => {
      const KEY = 'bf6-meta-state-v2';
      const store = typeof window !== 'undefined' && window.localStorage ? window.localStorage : null;
      let data = { weapons: {}, order: [] };

      const raw = store ? store.getItem(KEY) : null;
      const sanitized = typeof raw === 'string' ? raw.trim() : '';
      if (sanitized && (sanitized.startsWith('{') || sanitized.startsWith('['))) {
        const parsed = JSON.parse(sanitized);
        if (parsed && typeof parsed === 'object') {
          data = {
            weapons: parsed.weapons && typeof parsed.weapons === 'object' ? parsed.weapons : {},
            order: Array.isArray(parsed.order) ? parsed.order : []
          };
        }
      }

      function save() {
        if (!store) return;
        store.setItem(KEY, JSON.stringify(data));
      }

      function ensureWeapon(id) {
        if (!data.weapons[id]) {
          data.weapons[id] = {};
          save();
        }
      }

      return {
        getWeaponState(id) {
          ensureWeapon(id);
          return { ...data.weapons[id] };
        },
        updateWeaponState(id, patch) {
          ensureWeapon(id);
          data.weapons[id] = { ...data.weapons[id], ...patch };
          save();
        },
        getOrder() {
          return Array.isArray(data.order) ? [...data.order] : [];
        },
        setOrder(order) {
          if (!Array.isArray(order)) return;
          data.order = [...order];
          save();
        }
      };
    })();

    let currentDraggedId = null;

    class WeaponTracker {
      constructor(config) {
        this.config = config;
        this.id = config.id;
        this.minLevel = Number.isFinite(config.minLevel) ? config.minLevel : 1;
        this.maxLevel = Number.isFinite(config.maxLevel) ? config.maxLevel : 40;
        this.apMax = Number.isFinite(config.apMax) ? config.apMax : 100;
        this.slotLabels = { ...(config.slotLabels || {}) };
        for (const key of Object.keys(this.slotLabels)) {
          this.slotLabels[key] = toUpperSafe(this.slotLabels[key]);
        }
        this.baseline = config.baseline || {};
        this.changes = config.changes || {};
        this.slotKeys = this.buildSlotKeys();

        const saved = storage.getWeaponState(this.id);
        const defaultLevel = Number.isFinite(config.initialLevel) ? config.initialLevel : this.minLevel;
        this.state = {
          level: this.clampLevel(Number.isFinite(saved.level) ? saved.level : defaultLevel),
          collapsed: Boolean(saved.collapsed),
          favorite: Boolean(saved.favorite)
        };

        this.arrowLayerEl = document.createElement('div');
        this.arrowLayerEl.className = 'arrow-layer';
      }

      buildSlotKeys() {
        const order = [];
        const seen = new Set();

        const addKey = (key, label) => {
          if (key === undefined || key === null) return;
          const stringKey = String(key);
          if (!seen.has(stringKey)) {
            order.push(stringKey);
            seen.add(stringKey);
          }
          if (label && !this.slotLabels[stringKey]) {
            this.slotLabels[stringKey] = toUpperSafe(label);
          }
        };

        if (Array.isArray(this.config.slotOrder)) {
          this.config.slotOrder.forEach((slot) => addKey(slot));
        }

        for (const [slot, data] of Object.entries(this.baseline || {})) {
          addKey(slot, data && data.type ? data.type : undefined);
        }

        for (const changeSet of Object.values(this.changes || {})) {
          if (!changeSet || typeof changeSet !== 'object') continue;
          for (const [slot, payload] of Object.entries(changeSet)) {
            if (payload && typeof payload === 'object' && payload.type) {
              addKey(slot, payload.type);
            } else {
              addKey(slot);
            }
          }
        }

        return order;
      }

      getSlotLabel(slotKey) {
        const label = this.slotLabels[String(slotKey)];
        if (typeof label === 'string') return label;
        const snapshot = this.baseline[slotKey];
        if (snapshot && snapshot.type) return toUpperSafe(snapshot.type);
        return `SLOT ${slotKey}`;
      }

      clampLevel(level) {
        const value = Math.round(level);
        return Math.max(this.minLevel, Math.min(this.maxLevel, value));
      }

  mount(template) {
    const fragment = template.content.cloneNode(true);
    this.cardEl = fragment.querySelector('.weapon-card');
    this.cardEl.dataset.weaponId = this.id;

        this.headerEl = this.cardEl.querySelector('.weapon-header');
        this.headerTextEl = this.cardEl.querySelector('.weapon-header-text');
        this.chevronBtn = this.cardEl.querySelector('.chevron-toggle');
        this.headerLevelEl = this.cardEl.querySelector('.header-level');
        this.dragHandleBtn = this.cardEl.querySelector('.drag-handle');
        this.favoriteBtn = this.cardEl.querySelector('.favorite-toggle');
        this.collapseBoxBtn = this.cardEl.querySelector('.collapse-box');
        this.favoriteIcon = this.favoriteBtn ? this.favoriteBtn.querySelector('span[aria-hidden="true"]') : null;
        this.favoriteText = this.favoriteBtn ? this.favoriteBtn.querySelector('.favorite-text') : null;
        this.collapseBtn = this.cardEl.querySelector('.collapse-toggle');
        this.weaponNameEl = this.cardEl.querySelector('.weapon-name');
        this.weaponTypeEl = this.cardEl.querySelector('.weapon-subtitle');
        this.typeChipEl = this.cardEl.querySelector('.type-chip');
        this.rankChipEl = this.cardEl.querySelector('.rank-chip');
        this.rangeChipEl = this.cardEl.querySelector('.range-chip');
        this.weaponImageWrapEl = this.cardEl.querySelector('.weapon-image-wrap');
        this.weaponImageEl = this.cardEl.querySelector('.weapon-image');
        this.weaponImagePhEl = this.cardEl.querySelector('.weapon-image-ph');
        this.levelPillEl = this.cardEl.querySelector('.level-pill');
        this.levelDisplayEl = this.cardEl.querySelector('.level-display');
        this.progressBarEl = this.cardEl.querySelector('.progress');
        this.progressKnobEl = this.cardEl.querySelector('.knob');
        this.levelDownBtn = this.cardEl.querySelector('.level-down');
        this.levelUpBtn = this.cardEl.querySelector('.level-up');
        this.apMeterEl = this.cardEl.querySelector('.ap-meter');
        this.apValueEl = this.cardEl.querySelector('.ap-value');
        this.apMaxEl = this.cardEl.querySelector('.ap-max');
        this.slotsEl = this.cardEl.querySelector('.slots');
        this.changesPanelEl = this.cardEl.querySelector('.changes-panel');
        this.recommendedPanelEl = this.cardEl.querySelector('.recommended-panel');
        this.recommendedListEl = this.cardEl.querySelector('.recommended-list');
        // Mini AP meter inside Recommended panel
        this.recommendedApMeterEl = this.recommendedPanelEl ? this.recommendedPanelEl.querySelector('.ap-meter') : null;
        this.recommendedApValueEl = this.recommendedPanelEl ? this.recommendedPanelEl.querySelector('.ap-value') : null;
        this.recommendedApMaxEl = this.recommendedPanelEl ? this.recommendedPanelEl.querySelector('.ap-max') : null;

        if (this.weaponNameEl) this.weaponNameEl.textContent = toUpperSafe(this.config.name || this.id);
        if (this.weaponTypeEl) this.weaponTypeEl.textContent = toUpperSafe(this.config.type || 'Mastery Loadout Progression');
        if (this.typeChipEl) {
          const typeLabel = toUpperSafe(this.config.type || 'Type Not Found');
          this.typeChipEl.textContent = typeLabel;
        }
        if (this.rankChipEl) {
          const r = (this.config.rank || '').toString().trim().toLowerCase();
          const map = { m: 'META', a: 'A TIER', b: 'B TIER', c: 'C TIER', d: 'D TIER' };
          const label = map[r] || 'UNRANKED';
          this.rankChipEl.textContent = label;
          this.rankChipEl.classList.remove('rank-m','rank-a','rank-b','rank-c','rank-d','rank-unranked');
          this.rankChipEl.classList.add(r && map[r] ? ('rank-' + r) : 'rank-unranked');
        }
                if (this.rangeChipEl) {
          const code = (this.config.tr || '').toString().trim().toUpperCase();
          const num = parseInt(code, 10);
          const typeLabel = toUpperSafe(this.config.type || 'TYPE'); const kind = typeLabel;
          if (Number.isFinite(num) && num >= 1 && num <= 4 && kind) {
            this.rangeChipEl.textContent = '#' + num + ' ' + kind;
            this.rangeChipEl.classList.remove('range-1','range-2','range-3','range-4','range-unranked');
            this.rangeChipEl.classList.add('range-' + num);
          } else {
            this.rangeChipEl.textContent = 'UNRANKED';
            this.rangeChipEl.classList.remove('range-1','range-2','range-3','range-4');
            this.rangeChipEl.classList.add('range-unranked');
          }
          if (!this.rangeChipEl.textContent || !this.rangeChipEl.textContent.trim()) {
            this.rangeChipEl.textContent = 'UNRANKED';
            this.rangeChipEl.classList.add('range-unranked');
          }
        }
        if (this.weaponImageWrapEl && this.weaponImageEl) {
          const imgName = typeof this.config.image === 'string' ? this.config.image.trim() : '';
          if (imgName) {
            const nameOrId = toUpperSafe(this.config.name || this.id);
            const hasPath = /[\\/]/.test(imgName) || /^(https?:)?\/\//i.test(imgName);
            const primary = hasPath ? imgName : `images/${imgName}`;
            const alternate = hasPath ? imgName : `Images/${imgName}`;
            let triedAlt = false;

            this.weaponImageWrapEl.classList.remove('placeholder');
            this.weaponImageEl.alt = nameOrId;
            const onError = () => {
              if (!triedAlt && alternate !== primary) {
                triedAlt = true;
                this.weaponImageEl.src = alternate;
              } else {
                this.weaponImageEl.removeEventListener('error', onError);
                this.weaponImageEl.removeAttribute('src');
                this.weaponImageWrapEl.classList.add('placeholder');
                this.weaponImageEl.alt = '';
              }
            };
            this.weaponImageEl.addEventListener('error', onError);
            this.weaponImageEl.addEventListener('load', () => {
              // On success, ensure placeholder is hidden and stop error fallback
              this.weaponImageWrapEl.classList.remove('placeholder');
              this.weaponImageEl.removeEventListener('error', onError);
            }, { once: true });
            this.weaponImageEl.src = primary;
          } else {
            this.weaponImageWrapEl.classList.add('placeholder');
            this.weaponImageEl.removeAttribute('src');
            this.weaponImageEl.alt = '';
          }
        }
        if (this.apMaxEl) this.apMaxEl.textContent = `/${this.apMax}`;

        if (this.progressBarEl) {
          this.progressBarEl.style.setProperty('--max-level', this.maxLevel - this.minLevel + 1);
          this.progressBarEl.setAttribute('aria-valuemin', String(this.minLevel));
          this.progressBarEl.setAttribute('aria-valuemax', String(this.maxLevel));
        }

        if (this.levelDownBtn) this.levelDownBtn.addEventListener('click', () => this.setLevel(this.state.level - 1));
        if (this.levelUpBtn) this.levelUpBtn.addEventListener('click', () => this.setLevel(this.state.level + 1));
        if (this.progressBarEl) {
          // Prevent this area from initiating card drag
          this.progressBarEl.setAttribute('draggable', 'false');
          this.progressBarEl.addEventListener('dragstart', (e) => { e.preventDefault(); });
          // Click to jump
          this.progressBarEl.addEventListener('click', (event) => this.handleProgressClick(event));
          // Pointer-based scrubbing
          this.progressBarEl.addEventListener('pointerdown', (event) => this.handleProgressPointerDown(event));
        }
        if (this.weaponImageWrapEl) {
          // Prevent drag-to-reorder from the image area
          this.weaponImageWrapEl.setAttribute('draggable', 'false');
          this.weaponImageWrapEl.addEventListener('dragstart', (e) => { e.preventDefault(); });
          this.weaponImageWrapEl.addEventListener('pointerdown', (e) => { e.stopPropagation(); });
        }
        const controlStack = this.cardEl.querySelector('.control-stack');
        if (controlStack) {
          controlStack.setAttribute('draggable', 'false');
          controlStack.addEventListener('dragstart', (e) => { e.preventDefault(); });
          controlStack.addEventListener('pointerdown', (e) => { e.stopPropagation(); });
        }
        if (this.favoriteBtn) this.favoriteBtn.addEventListener('click', () => this.toggleFavorite());
        if (this.collapseBtn) this.collapseBtn.addEventListener('click', () => this.toggleCollapse());
        if (this.collapseBoxBtn) this.collapseBoxBtn.addEventListener('click', () => this.toggleCollapse());

        // Title block and chevron toggle collapse
        if (this.headerTextEl) {
          this.headerTextEl.addEventListener('click', (event) => {
            const target = event.target;
            if (target && target.closest && target.closest('.header-controls')) return;
            this.toggleCollapse();
          });
          this.headerTextEl.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
              event.preventDefault();
              this.toggleCollapse();
            }
          });
        }
        if (this.chevronBtn) {
          this.chevronBtn.addEventListener('click', () => this.toggleCollapse());
        }

        if (this.dragHandleBtn) {
          this.dragHandleBtn.addEventListener('dragstart', (event) => this.handleDragStart(event));
          this.dragHandleBtn.addEventListener('dragend', () => this.handleDragEnd());
          // Remove legacy drag handle from DOM to slim header
          if (this.dragHandleBtn.parentElement) {
            this.dragHandleBtn.parentElement.removeChild(this.dragHandleBtn);
          }
        }
        if (this.headerEl) {
          this.headerEl.setAttribute('draggable', 'true');
          this.headerEl.addEventListener('dragstart', (event) => this.handleDragStart(event));
          this.headerEl.addEventListener('dragend', () => this.handleDragEnd());
        }

        this.cardEl.addEventListener('keydown', (event) => {
          const step = event.shiftKey ? 5 : 1;
          if (event.key === 'ArrowLeft') {
            event.preventDefault();
            this.setLevel(this.state.level - step);
          } else if (event.key === 'ArrowRight') {
            event.preventDefault();
            this.setLevel(this.state.level + step);
          } else if (event.key === 'Home') {
            event.preventDefault();
            this.setLevel(this.minLevel);
          } else if (event.key === 'End') {
            event.preventDefault();
            this.setLevel(this.maxLevel);
          }
        });

        this.applyFavoriteUI();
        this.applyCollapseState();
        if (this.progressBarEl) this.updateProgressUI(this.state.level);
        // Ensure recommended panel starts hidden unless data populates it.
        if (this.recommendedPanelEl) this.recommendedPanelEl.hidden = true;
        this.render();
        this.renderRecommended();

        this.cardEl.remove();
      }
      attach(container) {
        if (!this.cardEl) return;
        container.appendChild(this.cardEl);
      }

      isFavorite() {
        return Boolean(this.state.favorite);
      }

      handleDragStart(event) {
        // Do not start reordering when dragging from interactive header controls or image
        if (event && event.target && event.target.closest && (event.target.closest('.header-controls') || event.target.closest('.weapon-image') || event.target.closest('.weapon-image-wrap') || event.target.closest('.control-stack') || event.target.closest('.collapse-box') || event.target.closest('.favorite-toggle'))) {
          event.preventDefault();
          return;
        }
        if (currentDraggedId && currentDraggedId !== this.id) {
          event.preventDefault();
          return;
        }
        currentDraggedId = this.id;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', this.id);
        this.cardEl.classList.add('dragging');
      }

      handleDragEnd() {
        this.cardEl.classList.remove('dragging');
        currentDraggedId = null;
      }

      toggleFavorite() {
        this.state.favorite = !this.state.favorite;
        storage.updateWeaponState(this.id, { favorite: this.state.favorite });
        this.applyFavoriteUI();
        renderWeaponList();
    alignSideNav();
      }

                  applyFavoriteUI() {
        if (this.cardEl) this.cardEl.classList.toggle('favorite', this.state.favorite);
        if (this.favoriteBtn) this.favoriteBtn.setAttribute('aria-pressed', this.state.favorite ? 'true' : 'false');
        if (this.favoriteIcon) {
          this.favoriteIcon.textContent = this.state.favorite ? '\u2605' : '\u2606';
        }
        if (this.favoriteText) {
          this.favoriteText.textContent = this.state.favorite ? 'Favorited' : 'Favorite';
        }
        if (this.favoriteBtn) {
          this.favoriteBtn.title = this.state.favorite ? 'Unfavorite' : 'Favorite';
        }
      }

      toggleCollapse() {
        this.state.collapsed = !this.state.collapsed;
        storage.updateWeaponState(this.id, { collapsed: this.state.collapsed });
        this.applyCollapseState();
        if (!this.state.collapsed) {
          this.renderSlots(this.state.level);
          this.renderChanges(this.state.level);
        }
      }

      applyCollapseState() {
        if (this.cardEl) this.cardEl.classList.toggle('collapsed', this.state.collapsed);
        if (this.collapseBtn) {
          this.collapseBtn.setAttribute('aria-expanded', this.state.collapsed ? 'false' : 'true');
          this.collapseBtn.textContent = this.state.collapsed ? 'Show' : 'Hide';
        }
        if (this.chevronBtn) this.chevronBtn.setAttribute('aria-expanded', this.state.collapsed ? 'false' : 'true');
        if (this.collapseBoxBtn) {
          this.collapseBoxBtn.textContent = this.state.collapsed ? '\u25B8' : '\u25BE';
          this.collapseBoxBtn.setAttribute('aria-expanded', this.state.collapsed ? 'false' : 'true');
        }
        if (this.headerTextEl) this.headerTextEl.setAttribute('aria-expanded', this.state.collapsed ? 'false' : 'true');
      }

      setLevel(level) {
        const next = this.clampLevel(level);
        if (next === this.state.level) return;
        this.state.level = next;
        storage.updateWeaponState(this.id, { level: next });
        this.render();
      }

      handleProgressClick(event) {
        const rect = this.progressBarEl.getBoundingClientRect();
        const ratio = rect.width > 0 ? (event.clientX - rect.left) / rect.width : 0;
        const level = Math.round(ratio * (this.maxLevel - this.minLevel)) + this.minLevel;
        this.setLevel(level);
      }

      handleProgressPointerDown(event) {
        if (!this.progressBarEl) return;
        // Only act on primary pointer
        if (event.button !== undefined && event.button !== 0) return;
        event.preventDefault();
        event.stopPropagation();
        this._progressScrubbing = true;
        this._progressPointerId = event.pointerId;
        // Temporarily disable header drag while scrubbing
        if (this.headerEl) this.headerEl.setAttribute('draggable', 'false');

        // Bind move/end handlers once per scrub session
        this._boundProgressMove = (e) => this.handleProgressPointerMove(e);
        this._boundProgressEnd = (e) => this.handleProgressPointerEnd(e);

        try { this.progressBarEl.setPointerCapture(event.pointerId); } catch (_) {}
        this.progressBarEl.addEventListener('pointermove', this._boundProgressMove);
        this.progressBarEl.addEventListener('pointerup', this._boundProgressEnd, { once: true });
        this.progressBarEl.addEventListener('pointercancel', this._boundProgressEnd, { once: true });

        // Update immediately on down
        this.handleProgressPointerMove(event);
      }

      handleProgressPointerMove(event) {
        if (!this._progressScrubbing || !this.progressBarEl) return;
        event.preventDefault();
        event.stopPropagation();
        const rect = this.progressBarEl.getBoundingClientRect();
        const x = event.clientX;
        const rawRatio = rect.width > 0 ? (x - rect.left) / rect.width : 0;
        const ratio = Math.max(0, Math.min(1, rawRatio));
        const level = Math.round(ratio * (this.maxLevel - this.minLevel)) + this.minLevel;
        this.setLevel(level);
      }

      handleProgressPointerEnd(event) {
        if (!this._progressScrubbing) return;
        event.preventDefault();
        event.stopPropagation();
        this._progressScrubbing = false;
        try {
          if (this._progressPointerId != null) this.progressBarEl.releasePointerCapture(this._progressPointerId);
        } catch (_) {}
        this._progressPointerId = null;
        if (this.progressBarEl && this._boundProgressMove) {
          this.progressBarEl.removeEventListener('pointermove', this._boundProgressMove);
        }
        this._boundProgressMove = null;
        this._boundProgressEnd = null;
        // Re-enable header dragging after scrubbing completes
        if (this.headerEl) this.headerEl.setAttribute('draggable', 'true');
      }

      ensureProgressSegments() {
        const desired = this.maxLevel - this.minLevel + 1;
        const existing = this.progressBarEl.querySelectorAll('.segment').length;
        if (existing === desired) return;
        this.progressBarEl.querySelectorAll('.segment').forEach((segment) => segment.remove());
        const frag = document.createDocumentFragment();
        for (let i = 0; i < desired; i++) {
          const segment = document.createElement('div');
          segment.className = 'segment';
          frag.appendChild(segment);
        }
        this.progressBarEl.insertBefore(frag, this.progressKnobEl);
      }

      updateProgressUI(level) {
        this.ensureProgressSegments();
        const segments = this.progressBarEl.querySelectorAll('.segment');
        const index = level - this.minLevel;
        segments.forEach((segment, idx) => {
          if (idx <= index) {
            segment.classList.add('active');
          } else {
            segment.classList.remove('active');
          }
        });
        const denominator = Math.max(1, this.maxLevel - this.minLevel);
        const percent = denominator === 0 ? 0 : ((level - this.minLevel) / denominator) * 100;
        this.progressKnobEl.style.left = `${percent}%`;
        this.progressBarEl.setAttribute('aria-valuenow', String(level));
      }

      ensureApMeterCells() {
        if (!this.apMeterEl || this.apMeterEl.children.length) return;
        const cellCount = Math.max(1, Math.round(this.apMax / 10));
        const frag = document.createDocumentFragment();
        for (let i = 0; i < cellCount; i++) {
          const cell = document.createElement('span');
          cell.className = 'ap-cell';
          const iconWrapper = document.createElement('span');
          iconWrapper.className = 'ap-icon';

          const icon = document.createElement('img');
          icon.src = AP_ICON;
          icon.alt = 'Attachment Points';
          iconWrapper.appendChild(icon);

          const firstFill = document.createElement('span');
          firstFill.className = 'ap-fill first';
          iconWrapper.appendChild(firstFill);

          const secondFill = document.createElement('span');
          secondFill.className = 'ap-fill second';
          iconWrapper.appendChild(secondFill);

          cell.appendChild(iconWrapper);
          frag.appendChild(cell);
        }
        this.apMeterEl.appendChild(frag);
      }

      updateApMeter(total) {
        this.ensureApMeterCells();
        if (!this.apMeterEl) return;
        const cells = Array.from(this.apMeterEl.children);
        if (!cells.length) return;
        if (this.apMax <= 0) {
          cells.forEach((cell) => cell.classList.remove('half', 'full'));
          return;
        }
        const cappedTotal = Math.max(0, Math.min(total, this.apMax));
        const perCell = this.apMax / cells.length;
        cells.forEach((cell, index) => {
          const cellMin = perCell * index;
          const cellMax = cellMin + perCell;
          const amountInCell = Math.max(0, Math.min(cappedTotal, cellMax) - cellMin);
          const halfThreshold = perCell / 2;
          const isFull = amountInCell >= perCell - 0.01;
          const isHalf = !isFull && amountInCell >= halfThreshold - 0.01;
          cell.classList.remove('half', 'full');
          if (isFull) {
            cell.classList.add('full');
          } else if (isHalf) {
            cell.classList.add('half');
          }
        });
      }

      // Helpers to drive an AP meter for a specific element (used by Recommended panel)
      ensureApMeterCellsFor(meterEl) {
        if (!meterEl || meterEl.children.length) return;
        const cellCount = Math.max(1, Math.round(this.apMax / 10));
        const frag = document.createDocumentFragment();
        for (let i = 0; i < cellCount; i++) {
          const cell = document.createElement('span');
          cell.className = 'ap-cell';
          const iconWrapper = document.createElement('span');
          iconWrapper.className = 'ap-icon';
          const icon = document.createElement('img');
          icon.src = AP_ICON;
          icon.alt = 'Attachment Points';
          iconWrapper.appendChild(icon);
          const firstFill = document.createElement('span');
          firstFill.className = 'ap-fill first';
          iconWrapper.appendChild(firstFill);
          const secondFill = document.createElement('span');
          secondFill.className = 'ap-fill second';
          iconWrapper.appendChild(secondFill);
          cell.appendChild(iconWrapper);
          frag.appendChild(cell);
        }
        meterEl.appendChild(frag);
      }

      updateApMeterFor(meterEl, total) {
        if (!meterEl) return;
        this.ensureApMeterCellsFor(meterEl);
        const cells = Array.from(meterEl.children);
        if (!cells.length) return;
        const max = this.apMax;
        if (max <= 0) {
          cells.forEach((cell) => cell.classList.remove('half', 'full'));
          return;
        }
        const cappedTotal = Math.max(0, Math.min(total, max));
        const perCell = max / cells.length;
        cells.forEach((cell, index) => {
          const cellMin = perCell * index;
          const cellMax = cellMin + perCell;
          const amountInCell = Math.max(0, Math.min(cappedTotal, cellMax) - cellMin);
          const halfThreshold = perCell / 2;
          const isFull = amountInCell >= perCell - 0.01;
          const isHalf = !isFull && amountInCell >= halfThreshold - 0.01;
          cell.classList.remove('half', 'full');
          if (isFull) cell.classList.add('full');
          else if (isHalf) cell.classList.add('half');
        });
      }

      createApDisplay(value) {
        if (!Number.isFinite(value)) return null;
        const wrapper = document.createElement('span');
        wrapper.className = 'ap-inline';
        const icon = document.createElement('img');
        icon.src = AP_ICON;
        icon.alt = 'Attachment Points';
        wrapper.appendChild(icon);
        const text = document.createElement('span');
        text.textContent = `${value}`;
        wrapper.appendChild(text);
        return wrapper;
      }

      createCard(data, options = {}) {
        if (!data) return null;
        const card = document.createElement('div');
        card.className = 'slot-card';
        if (options.old) card.classList.add('old');
        if (options.changed) card.classList.add('changed');
        if (options.indented) card.classList.add('indented');
        if (options.removed) card.classList.add('removed');

        const top = document.createElement('div');
        top.className = 'card-top';

        const info = document.createElement('div');
        info.className = 'card-info';

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = toUpperSafe(data.name);
        info.appendChild(title);

        const meta = document.createElement('div');
        meta.className = 'card-meta';
        const type = document.createElement('span');
        type.className = 'meta-type';
        type.textContent = toUpperSafe(data.type || 'ATTACHMENT');
        meta.appendChild(type);

        if (typeof data.pts === 'number') {
          const separator = document.createElement('span');
          separator.className = 'meta-separator';
          separator.textContent = '\u2022';
          meta.appendChild(separator);

          const pts = this.createApDisplay(data.pts);
          if (pts) {
            pts.classList.add('meta-pts');
            meta.appendChild(pts);
          }
        }

        info.appendChild(meta);
        top.appendChild(info);

        const levelBadge = document.createElement('div');
        levelBadge.className = 'card-level';
        const displayLevel = options.level ?? data.unlockLevel;
        if (options.hideLevel) {
          levelBadge.textContent = 'Unlocked';
        } else if (displayLevel) {
          levelBadge.textContent = `Level ${displayLevel}`;
        } else {
          levelBadge.textContent = 'Unlocked';
        }
        top.appendChild(levelBadge);

        card.appendChild(top);

        if (typeof data.description === 'string' && data.description.trim()) {
          const description = document.createElement('div');
          description.className = 'card-description';
          description.textContent = data.description.trim();
          card.appendChild(description);
        }

        return card;
      }

      createPlaceholderCard() {
        // Placeholder no longer renders a visible box; return an empty fragment
        const frag = document.createDocumentFragment();
        return frag;
      }
      computeState(level) {
        const snapshot = {};
        for (const slot of this.slotKeys) {
          snapshot[slot] = null;
        }

        for (const [slot, data] of Object.entries(this.baseline || {})) {
          if (!data) continue;
          const slotKey = String(slot);
          const unlockLevel = Number.isFinite(data.unlockLevel) ? data.unlockLevel : this.minLevel;
          const entry = normalizeEntry(data, unlockLevel);
          if (entry) {
            snapshot[slotKey] = entry;
          }
        }

        const sortedLevels = Object.keys(this.changes || {})
          .map((value) => Number(value))
          .filter((value) => !Number.isNaN(value))
          .sort((a, b) => a - b);

        for (const changeLevel of sortedLevels) {
          if (changeLevel > level) break;
          const changeSet = this.changes[changeLevel];
          if (!changeSet || typeof changeSet !== 'object') continue;
          for (const [slot, payload] of Object.entries(changeSet)) {
            const slotKey = String(slot);
            if (payload === null) {
              snapshot[slotKey] = null;
            } else {
              const unlockLevel = Number.isFinite(payload.unlockLevel) ? payload.unlockLevel : changeLevel;
              const entry = normalizeEntry(payload, unlockLevel);
              if (entry) {
                snapshot[slotKey] = entry;
              }
            }
          }
        }

        return snapshot;
      }

      diffAtLevel(level) {
        const changeSet = this.changes[level];
        if (!changeSet || typeof changeSet !== 'object') return {};
        const diff = {};
        for (const [slot, payload] of Object.entries(changeSet)) {
          const slotKey = String(slot);
          if (payload === null) {
            diff[slotKey] = null;
          } else {
            const unlockLevel = Number.isFinite(payload.unlockLevel) ? payload.unlockLevel : level;
            const entry = normalizeEntry(payload, unlockLevel);
            if (entry) {
              diff[slotKey] = entry;
            }
          }
        }
        return diff;
      }

      renderSlots(level) {
        this.slotsEl.innerHTML = '';
        const current = this.computeState(level);
        const previous = this.computeState(Math.max(this.minLevel - 1, level - 1));
        const diff = this.diffAtLevel(level);
        const arrowPairs = [];

        for (const slot of this.slotKeys) {
          const wrapper = document.createElement('div');
          wrapper.className = 'slot-wrapper';
          const label = document.createElement('div');
          label.className = 'slot-label';
          label.textContent = this.getSlotLabel(slot);
          wrapper.appendChild(label);
          let hasCard = false;

          const change = diff.hasOwnProperty(slot) ? diff[slot] : undefined;

          if (change !== undefined) {
            const previousData = previous[slot];
            if (change === null) {
              if (previousData) {
                const oldLevel = Number.isFinite(previousData.unlockLevel)
                  ? previousData.unlockLevel
                  : level;
                const oldCard = this.createCard(previousData, {
                  old: true,
                  removed: true,
                  level: oldLevel
                });
                if (oldCard) {
                  wrapper.appendChild(oldCard);
                  hasCard = true;
                }
              } else {
                // No previous attachment; do not render a placeholder box
              }
            } else {
              const replacedMeta = Array.isArray(change.replaced) ? change.replaced : [];
              let oldCardData = previousData ? { ...previousData } : null;
              let oldLevel = oldCardData && Number.isFinite(oldCardData.unlockLevel)
                ? oldCardData.unlockLevel
                : level;

              if (replacedMeta.length) {
                const match = oldCardData
                  ? replacedMeta.find((entry) => entry.name === oldCardData.name)
                  : replacedMeta[0];
                if (match) {
                  if (oldCardData) {
                    oldCardData = { ...oldCardData, ...match };
                  } else {
                    oldCardData = {
                      name: match.name || 'Previous attachment',
                      pts: match.pts ?? 0,
                      type: match.type || this.getSlotLabel(slot),
                      unlockLevel: Number.isFinite(match.unlockLevel) ? match.unlockLevel : level
                    };
                  }
                  oldLevel = Number.isFinite(match.unlockLevel)
                    ? match.unlockLevel
                    : oldCardData.unlockLevel ?? level;
                  const normalized = normalizeEntry(
                    oldCardData,
                    Number.isFinite(oldCardData.unlockLevel) ? oldCardData.unlockLevel : oldLevel
                  );
                  if (normalized) {
                    oldCardData = normalized;
                  }
                }
              }

              let oldCard = null;
              if (oldCardData) {
                oldCard = this.createCard(oldCardData, { old: true, level: oldLevel });
                if (oldCard) {
                  wrapper.appendChild(oldCard);
                  hasCard = true;
                }
              }

              const newCard = this.createCard(change, {
                changed: true,
                indented: Boolean(oldCard),
                level: Number.isFinite(change.unlockLevel) ? change.unlockLevel : level
              });
              if (newCard) {
                wrapper.appendChild(newCard);
                hasCard = true;
              }
              if (oldCard && newCard) {
                arrowPairs.push({ oldEl: oldCard, newEl: newCard });
              }
            }
          } else {
            const currentData = current[slot];
            if (currentData) {
              const prevData = previous[slot];
              const changed = prevData ? prevData.name !== currentData.name : level > this.minLevel;
              const card = this.createCard(currentData, {
                changed,
                level: currentData.unlockLevel,
                hideLevel: currentData.unlockLevel ? currentData.unlockLevel > level : false
              });
              if (card) {
                wrapper.appendChild(card);
                hasCard = true;
              }
            } else {
              // No current attachment; do not render a placeholder box
            }
          }

          if (hasCard) {
            this.slotsEl.appendChild(wrapper);
          }
        }

        this.arrowLayerEl.innerHTML = '';
        this.slotsEl.appendChild(this.arrowLayerEl);
        requestAnimationFrame(() => this.drawArrows(arrowPairs));
      }

      renderChanges(level) {
        const diff = this.diffAtLevel(level);
        const previous = this.computeState(Math.max(this.minLevel - 1, level - 1));
        const container = this.changesPanelEl;
        container.innerHTML = '';
        const title = document.createElement('h3');
        title.textContent = 'Changes at this Level';
        container.appendChild(title);

        const entries = Object.entries(diff);
        if (!entries.length) {
          const empty = document.createElement('div');
          empty.className = 'changes-empty';
          empty.textContent = 'No changes unlocked at this level.';
          container.appendChild(empty);
          return;
        }

        for (const [slot, change] of entries) {
          const row = document.createElement('div');
          row.className = 'change-row';
          const slotName = this.getSlotLabel(slot) || `SLOT ${slot}`;
          const heading = document.createElement('div');
          heading.className = 'change-heading';

          if (change === null) {
            const prev = previous[slot];
            const prevName = prev ? prev.name : 'Previous attachment';
            const prevNameDisplay = toUpperSafe(prevName);
            // Normalize corrupted separators in some encodings
            heading.textContent = `${slotName} \u2014 Removed`;
            const detail = document.createElement('div');
            detail.className = 'change-detail';
            detail.textContent = `${prevNameDisplay} removed at Level ${level}.`;
            row.appendChild(heading);
            row.appendChild(detail);
          } else {
            const prev = previous[slot];
            const replacedMeta = Array.isArray(change.replaced) ? change.replaced : [];
            const fallbackPrev = prev
              ? null
              : replacedMeta.find((entry) => entry && entry.name) || replacedMeta[0] || null;
            const prevName = prev
              ? prev.name
              : fallbackPrev && fallbackPrev.name
              ? fallbackPrev.name
              : 'Baseline';
            const changeLevel = Number.isFinite(change.unlockLevel) ? change.unlockLevel : level;
            // Normalize corrupted separators in some encodings
            heading.textContent = `${slotName} \u2014 Level ${changeLevel}`;
            const detail = document.createElement('div');
            detail.className = 'change-detail';

            const prevSpan = document.createElement('span');
            prevSpan.className = 'change-prev';
            prevSpan.textContent = toUpperSafe(prevName);

            const arrow = document.createElement('span');
            arrow.className = 'change-arrow';
            arrow.textContent = '\u2192';

            const nextSpan = document.createElement('span');
            nextSpan.className = 'change-next';
            nextSpan.textContent = toUpperSafe(change.name);

            detail.appendChild(prevSpan);
            detail.appendChild(arrow);
            detail.appendChild(nextSpan);

            row.appendChild(heading);
            row.appendChild(detail);
          }

          container.appendChild(row);
        }
      }

      // Render static Recommended Build cards (not tied to mastery level)
      renderRecommended() {
        if (!this.recommendedPanelEl || !this.recommendedListEl) return;
        const source = this.config.recommended || this.config.recommendedBuild || this.config.recommended_build || null;
        let items = [];
        if (Array.isArray(source)) {
          items = source.slice();
        } else if (source && typeof source === 'object') {
          try { items = Object.values(source); } catch (_) { items = []; }
        }

        // Hide panel when no data provided
        if (!items.length) {
          this.recommendedListEl.innerHTML = '';
          this.recommendedPanelEl.hidden = true;
          return;
        }

        this.recommendedListEl.innerHTML = '';
        const frag = document.createDocumentFragment();
        let totalAp = 0;
        for (const payload of items) {
          if (!payload) continue;
          const unlock = Number.isFinite(payload.unlockLevel) ? payload.unlockLevel : undefined;
          const entry = normalizeEntry(payload, unlock);
          if (!entry) continue;
          const card = this.createCard(entry, { changed: true, hideLevel: false, level: entry.unlockLevel });
          if (card) frag.appendChild(card);
          if (typeof entry.pts === 'number') totalAp += entry.pts;
        }
        this.recommendedListEl.appendChild(frag);
        // Update mini AP meter
        if (this.recommendedApValueEl) {
          const clamped = Math.max(0, Math.min(totalAp, this.apMax));
          this.recommendedApValueEl.textContent = `${Math.round(clamped)}`;
        }
        if (this.recommendedApMaxEl) this.recommendedApMaxEl.textContent = `/${this.apMax}`;
        if (this.recommendedApMeterEl) this.updateApMeterFor(this.recommendedApMeterEl, totalAp);
        this.recommendedPanelEl.hidden = false;
      }

      updateAp(level) {
        const snapshot = this.computeState(level);
        let total = 0;
        for (const value of Object.values(snapshot)) {
          if (value && typeof value.pts === 'number') {
            total += value.pts;
          }
        }
        if (this.apValueEl) {
          const clamped = Math.max(0, Math.min(total, this.apMax));
          this.apValueEl.textContent = `${Math.round(clamped)}`;
        }
        this.updateApMeter(total);
        return total;
      }

      drawArrows(pairs) {
        this.arrowLayerEl.innerHTML = '';
        if (!pairs.length) return;
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#00e5ff';

        for (const pair of pairs) {
          if (!pair.oldEl || !pair.newEl) continue;
          const startY = this.offsetWithinContainer(pair.oldEl) + pair.oldEl.offsetHeight;
          const endY = this.offsetWithinContainer(pair.newEl) + pair.newEl.offsetHeight / 2;
          const vertical = Math.max(0, endY - startY);
          const height = vertical + 16;
          const arrowSize = 6;
          const oldLeft = this.offsetLeftWithinContainer(pair.oldEl);
          const newLeft = this.offsetLeftWithinContainer(pair.newEl);
          const baseLeft = Math.min(oldLeft, newLeft);
          const startX = CARD_PAD + 1 + (oldLeft - baseLeft);
          const rawTargetX = newLeft - baseLeft;
          const targetX = Math.max(startX, rawTargetX);
          const horizontal = Math.max(0, targetX - startX);
          const tipX = startX + horizontal;
          const width = Math.max(startX, tipX) + arrowSize + 4;

          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.classList.add('arrow-svg');
          svg.setAttribute('width', width);
          svg.setAttribute('height', height);
          svg.style.left = `${baseLeft}px`;
          svg.style.top = `${startY}px`;

          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', `M${startX} 1 v${vertical} h${horizontal}`);
          path.setAttribute('fill', 'none');
          path.setAttribute('stroke', accent.trim() || '#00e5ff');
          path.setAttribute('stroke-width', ARROW_STROKE);
          path.setAttribute('stroke-linejoin', 'round');
          path.setAttribute('stroke-linecap', 'round');

          const arrowHead = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          const tipY = vertical + 1;
          arrowHead.setAttribute('d', `M${tipX - arrowSize} ${tipY - arrowSize} L${tipX} ${tipY} L${tipX - arrowSize} ${tipY + arrowSize}`);
          arrowHead.setAttribute('fill', 'none');
          arrowHead.setAttribute('stroke', accent.trim() || '#00e5ff');
          arrowHead.setAttribute('stroke-width', ARROW_STROKE);
          arrowHead.setAttribute('stroke-linecap', 'round');
          arrowHead.setAttribute('stroke-linejoin', 'round');

          svg.appendChild(path);
          svg.appendChild(arrowHead);
          this.arrowLayerEl.appendChild(svg);
        }
      }

      offsetWithinContainer(element) {
        if (!element) return 0;
        let offset = 0;
        let node = element;
        const container = this.slotsEl;
        while (node && node !== container) {
          offset += node.offsetTop || 0;
          node = node.offsetParent;
        }
        return offset;
      }

      offsetLeftWithinContainer(element) {
        if (!element) return 0;
        let offset = 0;
        let node = element;
        const container = this.slotsEl;
        while (node && node !== container) {
          offset += node.offsetLeft || 0;
          node = node.offsetParent;
        }
        return offset;
      }

      render() {
        const level = this.state.level;
        if (this.levelPillEl) this.levelPillEl.textContent = `Level ${level}`;
        if (this.headerLevelEl) this.headerLevelEl.textContent = `LEVEL ${level}`;
        if (this.levelDisplayEl) this.levelDisplayEl.textContent = `Viewing mastery unlocks at level ${level}.`;
        if (this.levelDownBtn) this.levelDownBtn.disabled = level === this.minLevel;
        if (this.levelUpBtn) this.levelUpBtn.disabled = level === this.maxLevel;
        if (this.progressBarEl && this.progressKnobEl) this.updateProgressUI(level);
        this.updateAp(level);
        if (!this.state.collapsed) {
          this.renderSlots(level);
          this.renderChanges(level);
        }
      }

      refreshLayout() {
        if (this.state.collapsed) return;
        this.renderSlots(this.state.level);
      }
    }
    const KORD_BASELINE = {
      1: { name: '415MM FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 },
      2: { name: 'FOLDING VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 1 },
      3: { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 },
      4: { name: 'SINGLE-PORT BRAKE', pts: 5, type: 'Muzzle', unlockLevel: 1 },
      6: { name: '30 RND MAGAZINE', pts: 5, type: 'Magazine', unlockLevel: 1 },
      7: { name: 'CCO 2.00X', pts: 10, type: 'Scope', unlockLevel: 1 }
    };

    const KORD_CHANGES = {
      2: {
        5: {
          name: 'FLASHLIGHT',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 2
        }
      },
      3: {
        2: {
          name: 'ALLOY VERTICAL',
          pts: 20,
          type: 'Underbarrel',
          replaced: [
            { name: 'FOLDING VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 1 }
          ]
        }
      },
      6: {
        2: {
          name: 'RIBBED VERTICAL',
          pts: 20,
          type: 'Underbarrel',
          replaced: [
            { name: 'ALLOY VERTICAL', pts: 20, type: 'Underbarrel', unlockLevel: 3 }
          ]
        }
      },
      7: {
        1: {
          name: '415MM PROTOTYPE',
          pts: 10,
          type: 'Barrel',
          replaced: [
            { name: '415MM FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 }
          ]
        }
      },
      8: {
        2: {
          name: '6H64 VERTICAL',
          pts: 20,
          type: 'Underbarrel',
          replaced: [
            { name: 'RIBBED VERTICAL', pts: 20, type: 'Underbarrel', unlockLevel: 6 }
          ]
        }
      },
      12: {
        5: {
          name: 'RED LASER',
          pts: 10,
          type: 'Right Accessory',
          replaced: [
            { name: 'FLASHLIGHT', pts: 10, type: 'Right Accessory', unlockLevel: 2 }
          ]
        }
      },
      13: {
        6: {
          name: '36 RND MAGAZINE',
          pts: 15,
          type: 'Ammunition',
          replaced: [
            { name: '30 RND MAGAZINE', pts: 5, type: 'Ammunition', unlockLevel: 1 }
          ]
        }
      },
      15: {
        7: {
          name: '3VZR 1.75x',
          pts: 10,
          type: 'Scope',
          replaced: [
            { name: 'CCO 2.00X', pts: 10, type: 'Scope', unlockLevel: 1 }
          ]
        }
      },
      16: {
        2: {
          name: 'CLASSIC VERTICAL',
          pts: 35,
          type: 'Underbarrel',
          replaced: [
            { name: '6H64 VERTICAL', pts: 20, type: 'Underbarrel', unlockLevel: 8 }
          ]
        },
        7: {
          name: 'RO-M 1.75x',
          pts: 10,
          type: 'Scope',
          replaced: [
            { name: '3VZR 1.75x', pts: 10, type: 'Scope', unlockLevel: 15 }
          ]
        }
      },
      20: {
        4: {
          name: 'COMPENSATED BRAKE',
          pts: 20,
          type: 'Muzzle',
          replaced: [
            { name: 'SINGLE-PORT BRAKE', pts: 5, type: 'Muzzle', unlockLevel: 1 }
          ]
        },
        5: null
      },
      24: {
        4: {
          name: 'STANDARD SUPPRESSOR',
          pts: 20,
          type: 'Muzzle',
          replaced: [
            { name: 'COMPENSATED BRAKE', pts: 20, type: 'Muzzle', unlockLevel: 20 }
          ]
        }
      },
      32: {
        4: {
          name: 'LONG SUPPRESSOR',
          pts: 25,
          type: 'Muzzle',
          replaced: [
            { name: 'STANDARD SUPPRESSOR', pts: 20, type: 'Muzzle', unlockLevel: 24 }
          ]
        }
      }
    };
    const PW5A3_BASELINE = {
      barrel: { name: '225MM FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 },
      underbarrel: { name: 'FOLDING VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 1 },
      ammunition: { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 },
      magazine: { name: '30 RND MAGAZINE', pts: 5, type: 'Magazine', unlockLevel: 1 },
      scope: { name: 'IRON SIGHTS', pts: 5, type: 'Scope', unlockLevel: 1 }
    };

    const PW5A3_CHANGES = {
      3: {
        underbarrel: {
          name: 'Alloy Vertical',
          pts: 5,
          type: 'Underbarrel',
          unlockLevel: 3,
          replaced: [
            { name: 'FOLDING VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 1 }
          ]
        }
      },
      5: {
        magazine: {
          name: '30RND FAST MAG',
          pts: 10,
          type: 'Magazine',
          unlockLevel: 5,
          replaced: [
            { name: '30 RND MAGAZINE', pts: 5, type: 'Magazine', unlockLevel: 1 }
          ]
        }
      },
      6: {
        underbarrel: {
          name: 'RIBBED VERTICAL',
          pts: 10,
          type: 'Underbarrel',
          unlockLevel: 6,
          replaced: [
            { name: 'Alloy Vertical', pts: 5, type: 'Underbarrel', unlockLevel: 3 }
          ]
        }
      },
      9: {
        muzzle: {
          name: 'STANDARD SUPPRESSOR',
          pts: 20,
          type: 'Muzzle',
          unlockLevel: 9
        }
      },
      12: {
        barrel: {
          name: '245mm Custom',
          pts: 15,
          type: 'Barrel',
          unlockLevel: 12
        },
        ergonomics: {
          name: 'Improved Mag Catch',
          pts: 5,
          type: 'Ergonomics',
          unlockLevel: 12
        }
      },
      14: {
        underbarrel: {
          name: '6H64 VERTICAL',
          pts: 25,
          type: 'Underbarrel',
          unlockLevel: 14,
          replaced: [
            { name: 'RIBBED VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 6 }
          ]
        }
      },
      21: {
        underbarrel: {
          name: 'CLASSIC VERTICAL',
          pts: 35,
          type: 'Underbarrel',
          unlockLevel: 21,
          replaced: [
            { name: '6H64 VERTICAL', pts: 25, type: 'Underbarrel', unlockLevel: 14 }
          ]
        }
      },
      28: {
        underbarrel: {
          name: '6H64 Vertical',
          pts: 25,
          type: 'Underbarrel',
          unlockLevel: 14,
          replaced: [
            { name: 'CLASSIC VERTICAL', pts: 35, type: 'Underbarrel', unlockLevel: 21 }
          ]
        },
        magazine: {
          name: '40 RND Magazine',
          pts: 25,
          type: 'Magazine',
          unlockLevel: 28,
          replaced: [
            { name: '30RND FAST MAG', pts: 10, type: 'Magazine', unlockLevel: 5 }
          ]
        }
      }
    };
    const RPKM_BASELINE = {
      // 590MM FACTORY
      barrel: { name: '590MM FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 },
      underbarrel: { name: 'FOLDING VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 1 },
      ammunition: { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 },
      magazine: { name: '40 RND MAGAZINE', pts: 25, type: 'Magazine', unlockLevel: 1 },
      muzzle: { name: 'Flash Hider', pts: 10, type: 'Muzzle', unlockLevel: 1 },
      scope: { name: 'MINI FLEX 1.00X', pts: 10, type: 'Scope', unlockLevel: 1 }
    };
    const RPKM_CHANGES = {
      2: { 
        scope: {
          name: 'RO-M 1.75x',
          pts: 10,
          type: 'Scope',
          unlockLevel: 2,
          replaced: [
            { name: 'MINI FLEX 1.00X', pts: 10, type: 'Scope', unlockLevel: 28 }
          ]
        }
      },
      4: {
        underbarrel: {
          name: 'ALLOY VERTICAL',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 4,
          replaced: [
            { name: 'FOLDING VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 1 }
          ]
        }
      },
      5: {
        rightAccessory: {
          name: '5 MW RED',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 5
        }
      },
      6: {
        underbarrel: {
          name: 'RIBBED VERTICAL',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 6,
          replaced: [
            { name: 'ALLOY VERTICAL', pts: 20, type: 'Underbarrel', unlockLevel: 4 }
          ]
        }
      },
      8: {
        leftAccessory: {
          name: 'flashlight',
          pts: 10,
          type: 'Left Accessory',
          unlockLevel: 8
        }
      },
      9: {
        underbarrel: {
          name: 'Folding stubby',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 9,
          replaced: [
            { name: 'RIBBED VERTICAL', pts: 20, type: 'Underbarrel', unlockLevel: 6 }
          ]
        }
      }, 
      12: {
        rightAccessory: {
          name: '5 MW GREEN',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 12,
          replaced: [
            { name: '5 MW RED', pts: 10, type: 'Right Accessory', unlockLevel: 5 }
          ]
        }
      }, 
      18: {
        underbarrel: {
          name: 'Slim Angled',
          pts: 25,
          type: 'Underbarrel',
          unlockLevel: 18,
          replaced: [
            { name: 'Folding stubby', pts: 20, type: 'Underbarrel', unlockLevel: 9 }
          ]
        },
        leftAccessory: null
      },
      21: {
        barrel: {
          name: '600MM TABUK',
          pts: 15,
          type: 'Barrel',
          unlockLevel: 21,
          replaced: [
            { name: '590MM FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 }
          ]
        }
      },
      23: {
        underbarrel: {
          name: 'Canted Stubby',
          pts: 30,
          type: 'Underbarrel',
          unlockLevel: 23,
          replaced: [
            { name: 'Slim Angled', pts: 25, type: 'Underbarrel', unlockLevel: 18 }
          ]
        },
        rightAccessory: null
      },
      25: {
        underbarrel: {
          name: 'Full Angled',
          pts: 25,
          type: 'Underbarrel',
          unlockLevel: 25,
          replaced: [
            { name: 'Canted Stubby', pts: 30, type: 'Underbarrel', unlockLevel: 23 }
          ]
        },
        ammunition: {
          name: 'Polymer Case',
          pts: 10,
          type: 'Ammunition', 
          unlockLevel: 25,
          replaced: [
            { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 }
          ]
        }
      },
      35: {
        underbarrel: {
          name: 'Stippled Stubby',
          pts: 35,
          type: 'Underbarrel',
          unlockLevel: 35,
          replaced: [
            { name: 'Full Angled', pts: 25, type: 'Underbarrel', unlockLevel: 25 }
          ]
        },
        ammunition: {
          name: 'FMJ',
          pts: 5,
          type: 'Ammunition',
          unlockLevel: 35,
          replaced: [
            { name: 'Polymer Case', pts: 10, type: 'Ammunition', unlockLevel: 25 }
          ]
        }
      },
      38: {
        barrel: {
          name: '590mm Factory',
          pts: 10,
          type: 'Barrel',
          unlockLevel: 1,
          replaced: [
            { name: '600MM TABUK', pts: 15, type: 'Barrel', unlockLevel: 21 }
          ]
        },
        underbarrel: {
          name: 'Adjustable Angled',
          pts: 15,
          type: 'Underbarrel',
          unlockLevel: 16,
          replaced: [
            { name: 'Stippled Stubby', pts: 35, type: 'Underbarrel', unlockLevel: 35 }
          ]
        },
        ammunition: {
          name: 'Synthetic Tip',
          pts: 30,
          type: 'Ammunition',
          unlockLevel: 38,
          replaced: [
            { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 35 }
          ]
        },
        muzzle: {
          name: 'Lightened Suppressor',
          pts: 30,
          type: 'Muzzle',
          unlockLevel: 37,
        }
      }
    };
    const M87A1_BASELINE = {
      // Placeholder for future weapon baseline
      barrel: {
        name: '20" FACTORY',
        pts: 10,
        type: 'Barrel',
        unlockLevel: 1
      },
      ammunition: {
        name: 'BUCKSHOT',
        pts: 10,
        type: 'Ammunition',
        unlockLevel: 1
      },
      magazine: {
        name: '7 SHELL TUBE',
        pts: 5,
        type: 'Magazine',
        unlockLevel: 1
      },
      scope: {
        name: 'IRON SIGHTS',
        pts: 5,
        type: 'Scope',
        unlockLevel: 1
      }
    };
    const M87A1_CHANGES = {
      4: {
        rightAccessory: {
          name: '5 MW RED',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 4
        }
      },
      5: {
        underbarrel: {
          name: 'Ribbed Stubby',
          pts: 30,
          type: 'Underbarrel',
          unlockLevel: 5
        }
      },
      10: {
        underbarrel: {
          name: 'Slim Angled',
          pts: 25,
          type: 'Underbarrel',
          unlockLevel: 10,
          replaced: [
            { name: 'Ribbed Stubby', pts: 30, type: 'Underbarrel', unlockLevel: 5 }
          ]
        }
      },
      13: {
        leftAccessory: {
          name: 'FLASHLIGHT',
          pts: 10,
          type: 'Left Accessory',
          unlockLevel: 13
        }
      },
      15: { 
        rightAccessory: {
          name: '50 MW Blue',
          pts: 20,
          type: 'Right Accessory',
          unlockLevel: 15,
          replaced: [
            { name: '5 MW RED', pts: 10, type: 'Right Accessory', unlockLevel: 4 }
          ]
        }
      },
      18: {
        underbarrel: {
          name: 'Folding Stubby',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 17,
          replaced: [
            { name: 'Slim Angled', pts: 25, type: 'Underbarrel', unlockLevel: 10 }
          ]
        },
        muzzle: {
          name: 'CQB Suppressor',
          pts: 30,
          type: 'Muzzle',
          unlockLevel: 18
        },
        leftAccessory: null
      },
      19: {
        underbarrel: {
          name: 'Adjustable Angled',
          pts: 15,
          type: 'Underbarrel',
          unlockLevel: 19,
          replaced: [
            { name: 'Folding Stubby', pts: 20, type: 'Underbarrel', unlockLevel: 17 }
          ]
        }
      },
      22: {
        leftAccessory: {
          name : 'FLASHLIGHT',
          pts: 10,
          type: 'Left Accessory',
          unlockLevel: 13,
        },
        rightAccessory: {
          name: '5 MW GREEN',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 22,
          replaced: [
            { name: '5 MW Blue', pts: 20, type: 'Right Accessory', unlockLevel: 15 }
          ]
        }
      },
      26: {
        ammunition: {
          name: 'Flechette',
          pts: 30,
          type: 'Ammunition',
          unlockLevel: 26,
          replaced: [
            { name: 'BUCKSHOT', pts: 10, type: 'Ammunition', unlockLevel: 1 }
          ]
        },
        rightAccessory: null,
        leftAccessory: null
      },
    };
    const GGH_22_BASELINE = {
      barrel: {
        name: '114MM FACTORY',
        pts: 10,
        type: 'Barrel',
        unlockLevel: 1
      },
      underbarrel: {
        name: '5 MW RED',
        pts: 10,
        type: 'Underbarrel',
        unlockLevel: 1
      },
      ammunition: {
        name: 'FMJ',
        pts: 5,
        type: 'Ammunition',
        unlockLevel: 1
      },
      magazine: {
        name: '15RND MAGAZINE',
        pts: 5,
        type: 'Magazine',
        unlockLevel: 1
      },
      scope: {
        name: 'IRON SIGHTS',
        pts: 0,
        type: 'Scope',
        unlockLevel: 1
      }
    };
    const GGH_22_CHANGES = {
      2: {
        scope: {
          name: 'ROX 1.50X',
          pts: 10,
          type: 'Scope',
          unlockLevel: 2,
          replaced: [
            { name: 'IRON SIGHTS', pts: 0, type: 'Scope', unlockLevel: 1 }
          ]
        }
      },
      4: {
        ergonomics: {
          name: 'IMPROVED MAG CATCH',
          pts: 5,
          type: 'Ergonomics',
          unlockLevel: 4
        }
      },
      5: {
        underbarrel: {
          name: '5 MW GREEN',
          pts: 10,
          type: 'Underbarrel',
          unlockLevel: 5,
          replaced: [
            { name: '5 MW RED', pts: 10, type: 'Underbarrel', unlockLevel: 1 }
          ]
        }
      },
      7: {
        muzzle: {
          name: 'Single-Port Brake',
          pts: 10,
          type: 'Muzzle',
          unlockLevel: 7
        }
      },
      9: {
        barrel: {
          name: '114MM PENCIL',
          pts: 20,
          type: 'Barrel',
          unlockLevel: 9,
          replaced: [
            { name: '114MM FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 }
          ]
        },
        ergonomics: null
      },
      12: {
        barrel: {
          name: '114MM Factory',
          pts: 10,
          type: 'Barrel',
          unlockLevel: 1,
          replaced: [
            { name: '114MM PENCIL', pts: 20, type: 'Barrel', unlockLevel: 9 }
          ]
        },
        ergonomics: {
          name: 'IMPROVED MAG CATCH',
          pts: 5,
          type: 'Ergonomics',
          unlockLevel: 4
        },
        magazine: {
          name: '20RND MAGAZINE',
          pts: 20,
          type: 'Magazine',
          unlockLevel: 12,
          replaced: [
            { name: '15RND MAGAZINE', pts: 5, type: 'Magazine', unlockLevel: 1 }
          ]
        },
        underbarrel: null
      },
      15: {
        barrel: {
          name: '114MM PENCIL',
          pts: 20,
          type: 'Barrel',
          unlockLevel: 9,
          replaced: [
            { name: '114MM FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 }
          ]
        },
        muzzle: {
          name: 'Standard Suppressor',
          pts: 20,
          type: 'Muzzle',
          unlockLevel: 15,
          replaced: [
            { name: 'Single-Port Brake', pts: 10, type: 'Muzzle', unlockLevel: 7 }
          ]
        },
        magazine: {
          name: '15RND MAGAZINE',
          pts: 5,
          type: 'Magazine',
          unlockLevel: 1,
          replaced: [
            { name: '20RND MAGAZINE', pts: 20, type: 'Magazine', unlockLevel: 12 }
          ]
        },
        // Keep: barrel, muzzle, magazine, ammunition, scope. remove else
        ergonomics: null
      },
      18: { 
        scope: {
          name: 'A-P2 1.75x',
          pts: 10,
          type: 'Scope',
          unlockLevel: 18,
          replaced: [
            { name: 'ROX 1.50X', pts: 10, type: 'Scope', unlockLevel: 2 }
          ]
        }
      }
    };
    const L110_BASELINE = {
      barrel: {
        name: '349MM SB',
        pts: 10,
        type: 'Barrel',
        unlockLevel: 1
      },
      underbarrel: {
        name: 'CLASSIC GRIP POD',
        pts: 30,
        type: 'Underbarrel',
        unlockLevel: 1
      },
      ammunition: {
        name: 'FMJ',
        pts: 5,
        type: 'Ammunition',
        unlockLevel: 1
      },
      rightAccessory: {
        name: '5 MW GREEN',
        pts: 10,
        type: 'Right Accessory',
        unlockLevel: 1
      },
      magazine: {
        name: '100RND BELT POUCH',
        pts: 25,
        type: 'Magazine',
        unlockLevel: 1
      },
      scope: {
        name: 'R4T 2.00X',
        pts: 10,
        type: 'Scope',
        unlockLevel: 1
      }
    };
    const L110_CHANGES = {
      2: {
        muzzle: {
          name: 'single-port brake',
          pts: 5,
          type: 'Muzzle',
          unlockLevel: 2
        }
      },
      3: {
        barrel: {
          name: '465MM LB',
          pts: 10,
          type: 'Barrel',
          unlockLevel: 3,
          replaced: [
            { name: '349MM SB', pts: 10, type: 'Barrel', unlockLevel: 1 }
          ]
        }
      },
      5: {
        scope: {
          name: 'RO-M 1.75x',
          pts: 10,
          type: 'Scope',
          unlockLevel: 5,
          replaced: [
            { name: 'R4T 2.00X', pts: 10, type: 'Scope', unlockLevel: 1 }
          ]
        }
      },
      7: {
        muzzle: { 
          name: 'Linear Comp',
          pts: 10,
          type: 'Muzzle',
          unlockLevel: 7,
          replaced: [
            { name: 'single-port brake', pts: 5, type: 'Muzzle', unlockLevel: 2 }
          ]
        }
      },
      8: {
        leftAccessory: {
          name: 'FLASHLIGHT',
          pts: 10,
          type: 'Left Accessory',
          unlockLevel: 8
        }
      },
      9: {
        underbarrel: {
          name: 'Folding stubby',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 9,
          replaced: [
            { name: 'CLASSIC GRIP POD', pts: 30, type: 'Underbarrel', unlockLevel: 1 }
          ]
        }
      },
      15: {
        ammunition: {
          name: 'hollow point',
          pts: 20,
          type: 'Ammunition',
          unlockLevel: 15,
          replaced: [
            { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 }
          ]
        }
      },
      16: {
        underbarrel: {
          name: 'Slim Angled',
          pts: 25,
          type: 'Underbarrel',
          unlockLevel: 16,
          replaced: [
            { name: 'Folding stubby', pts: 20, type: 'Underbarrel', unlockLevel: 9 }
          ]
        }
      },
      17: {
        ammunition: {
          name: 'FMJ',
          pts: 5,
          type: 'Ammunition',
          unlockLevel: 1,
          replaced: [
            { name: 'hollow point', pts: 20, type: 'Ammunition', unlockLevel: 15 }
          ]
        },
        muzzle: {
          name: 'Compensated Brake',
          pts: 20,
          type: 'Muzzle',
          unlockLevel: 17,
          replaced: [
            { name: 'Linear Comp', pts: 10, type: 'Muzzle', unlockLevel: 7 }
          ]
        }
      },
      18: {
        rightAccessory: {
          name: '50 MW Green',
          pts: 20,
          type: 'Right Accessory',
          unlockLevel: 18,
          replaced: [
            { name: '5 MW GREEN', pts: 10, type: 'Right Accessory', unlockLevel: 1 }
          ]
        },
        //Keep: Scope, Magazine, Right Accessory, Muzzle, Ammunition, Underbarrel, Barrel. 
        leftAccessory: null  
      },
      21: {
        underbarrel: {
          name: 'Canted Stubby',
          pts: 30,
          type: 'Underbarrel',
          unlockLevel: 21,
          replaced: [
            { name: 'Slim Angled', pts: 25, type: 'Underbarrel', unlockLevel: 16 }
          ]
        }
      },
      23: {
        muzzle: {
          name: 'Standard Suppressor',
          pts: 20,
          type: 'Muzzle',
          unlockLevel: 23,
          replaced: [
            { name: 'Compensated Brake', pts: 20, type: 'Muzzle', unlockLevel: 17 }
          ]
        }
      },
      24: {
        underbarrel: {
          name: 'Full Angled',
          pts: 25,
          type: 'Underbarrel',
          unlockLevel: 24,
          replaced: [
            { name: 'Canted Stubby', pts: 30, type: 'Underbarrel', unlockLevel: 21 }
          ]
        }
      },
      28: {
        muzzle: { 
          name: 'Long Suppressor',
          pts: 25,
          type: 'Muzzle',
          unlockLevel: 28,
          replaced: [
            { name: 'Standard Suppressor', pts: 20, type: 'Muzzle', unlockLevel: 23 }
          ]
        }
      },
      35: {
        underbarrel: {
          name: 'Stippled Stubby',
          pts: 35,
          type: 'Underbarrel',
          unlockLevel: 35,
          replaced: [
            { name: 'Full Angled', pts: 25, type: 'Underbarrel', unlockLevel: 24 }
          ]
        },
        rightAccessory: {
          name: '5 MW GREEN',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 1,
          replaced: [
            { name: '50 MW Green', pts: 20, type: 'Right Accessory', unlockLevel: 18 }
          ]
        }
      },
      37: {
        barrel: {
          name: '349MM Fluted',
          pts: 20,
          type: 'Barrel',
          unlockLevel: 37,
          replaced: [
            { name: '465MM LB', pts: 10, type: 'Barrel', unlockLevel: 3 }
          ]
        },
        // Keep: Scope, Magazine, Muzzle, Ammunition, Underbarrel, Barrel.
        rightAccessory: null
      },
      39: {
        underbarrel: {
          name: 'Full Angled',
          pts: 25,
          type: 'Underbarrel',
          unlockLevel: 24,
          replaced: [
            { name: 'Stippled Stubby', pts: 35, type: 'Underbarrel', unlockLevel: 35 }
          ]
        },
        muzzle: {
          name: 'Lightened Suppressor',
          pts: 30,
          type: 'Muzzle',
          unlockLevel: 39,
          replaced: [
            { name: 'Long Suppressor', pts: 25, type: 'Muzzle', unlockLevel: 28 }
          ]
        }
      }
    };
    const m2010ESR_BASELINE = {
      ammunition: { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 },
      magazine: { name: '5RND MAGAZINE', pts: 5, type: 'Magazine', unlockLevel: 1 },
      scope: { name: 'SU-230 LPVO', pts: 20, type: 'Scope', unlockLevel: 1 }
    };
    const M2010ESR_CHANGES = {
      2: {
        barrel: {
          name: '24" Fluted',
          pts: 20,
          type: 'Barrel',
          unlockLevel: 2
        },
        underbarrel: {
          name: 'Full Angled',
          pts: 5,
          type: 'Underbarrel',
          unlockLevel: 2
        },
        leftAccessory: {
          name: 'Range Finder',
          pts: 15,
          type: 'Left Accessory',
          unlockLevel: 2
        },
        topAccessory: {
          name: '5 MW RED',
          pts: 10,
          type: 'Top Accessory',
          unlockLevel: 2
        },
        scope: {
          name: 'S-VPS 6.00X',
          pts: 10,
          type: 'Scope',
          unlockLevel: 2,
          replaced: [
            { name: 'SU-230 LPVO', pts: 20, type: 'Scope', unlockLevel: 1 }
          ]
        }
      },
      3: {
        ammunition: {
          name: 'Match Grade',
          pts: 10,
          type: 'Ammunition',
          unlockLevel: 3,
          replaced: [
            { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 }
          ]
        }
      },
      7: {
        topAccessory: {
          name: '5 MW GREEN',
          pts: 10,
          type: 'Top Accessory',
          unlockLevel: 7,
          replaced: [
            { name: '5 MW RED', pts: 10, type: 'Top Accessory', unlockLevel: 2 }
          ]
        }
      },
      10: {
        scope: {
          name: 'SSDS 6.00X',
          pts: 10,
          type: 'Scope',
          unlockLevel: 10,
          replaced: [
            { name: 'S-VPS 6.00X', pts: 10, type: 'Scope', unlockLevel: 2 }
          ]
        }
      },
      13: {
        ergonomics: {
          name: 'DLC Bolt',
          pts: 30,
          type: 'Ergonomics',
          unlockLevel: 13
        },
        // Keep: Barrel, Underbarrel, Ammunition, Ergonomics, Left Accessory, Magazine, Scope
        topAccessory: null
      },
      15: {
        magazine: {
          name: '5RND FAST MAG',
          pts: 10,
          type: 'Magazine',
          unlockLevel: 15,
          replaced: [
            { name: '5RND MAGAZINE', pts: 5, type: 'Magazine', unlockLevel: 1 }
          ]
        }
      },
      16: {
        barrel: {
          name: '26" Carbon',
          pts: 15,
          type: 'Barrel',
          unlockLevel: 16,
          replaced: [
            { name: '24" Fluted', pts: 20, type: 'Barrel', unlockLevel: 2 }
          ]
        }
      },
      36: {
        opticAccessory: {
          name: 'Anti-Glare Coating',
          pts: 10,
          type: 'Optic Accessory',
          unlockLevel: 36
        },
        magazine: {
          name: '5RND MAGAZINE',
          pts: 5,
          type: 'Magazine',
          unlockLevel: 1,
          replaced: [
            { name: '5RND FAST MAG', pts: 10, type: 'Magazine', unlockLevel: 15 }
          ]
        }
      }
    };
    const miniscout_baseline = {
      barrel: { name: '16" FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 },
      ammunition: { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 },
      magazine: { name: '10RND MAGAZINE', pts: 5, type: 'Magazine', unlockLevel: 1 },
      scope: { name: 'DVO LPVO', pts: 25, type: 'Scope', unlockLevel: 1 }
    };
    const miniscout_changes = {
      2: {
        underbarrel: {
          name: 'FULL ANGLED',
          pts: 5,
          type: 'Underbarrel',
          unlockLevel: 2
        }
      },
      3: {
        rightAccessory: {
          name: '5 MW RED',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 3
        }
      },
      4: {
        barrel: {
          name: '18" EXTENDED',
          pts: 15,
          type: 'Barrel',
          unlockLevel: 4,
          replaced: [
            { name: '16" FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 }
          ]
        }
      },
      6: {
        leftAccessory: {
          name: 'FLASHLIGHT',
          pts: 10,
          type: 'Left Accessory',
          unlockLevel: 6
        }
      },
      8: {
        magazine: {
          name: '10RND FAST MAG',
          pts: 10,
          type: 'Magazine',
          unlockLevel: 8,
          replaced: [
            { name: '10RND MAGAZINE', pts: 5, type: 'Magazine', unlockLevel: 1 }
          ]
        }
      },
      12: {
        rightAccessory: {
          name: '5 MW GREEN',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 12,
          replaced: [
            { name: '5 MW RED', pts: 10, type: 'Right Accessory', unlockLevel: 3 }
          ]
        }
      }, 
      19: { 
        muzzle: {
          name: 'Standard SUPPRESSOR',
          pts: 25,
          type: 'Muzzle',
          unlockLevel: 19
        }
      },
      24: {
        leftAccessory: {
          name: 'Range Finder',
          pts: 15,
          type: 'Left Accessory',
          unlockLevel: 24
        },
        // Keep: Barrel, Underbarrel, Ammunition, Muzzle, Magazine, Scope, Left Accessory.
        rightAccessory: null
      },
      40: {
        opticAccessory: {
          name: 'Anti-Glare Coating',
          pts: 10,
          type: 'Optic Accessory',
          unlockLevel: 40
        },
        rightAccessory: {
          name: '5 MW GREEN',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 40
        },
        muzzle: null
      }
    };
    const umg40_baseline = {
      barrel: { name: '200MM FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 },
      underbarrel: { name: 'FOLDING VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 1 },
      ammunition: { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 },
      magazine: { name: '30RND MAGAZINE', pts: 5, type: 'Magazine', unlockLevel: 1 },
      scope: { name: 'R4T 2.00X', pts: 10, type: 'Scope', unlockLevel: 1 }
    };
    const umg40_changes = {
      3: {
        rightAccessory: {
          name: '5 MW RED',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 3
        }
      },
      7: {
        underbarrel: {
          name: 'alloy vertical',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 7,
          replaced: [
            { name: 'FOLDING VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 1 }
          ]
        },
        scope: {
          name: 'A-P2 1.75x',
          pts: 10,
          type: 'Scope',
          unlockLevel: 7,
          replaced: [
            { name: 'R4T 2.00X', pts: 10, type: 'Scope', unlockLevel: 1 }
          ]
        }
      },
      8: {
        muzzle: {
          name: 'linear comp',
          pts: 10,
          type: 'Muzzle',
          unlockLevel: 8
        }
      },
      11: { 
        underbarrel: {
          name: 'ribbed vertical',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 11,
          replaced: [
            { name: 'alloy vertical', pts: 20, type: 'Underbarrel', unlockLevel: 7 }
          ]
        }
      },
      12: {
        rightAccessory: {
          name: '5 MW GREEN',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 12,
          replaced: [
            { name: '5 MW RED', pts: 10, type: 'Right Accessory', unlockLevel: 3 }
          ]
        }
      },
      14: { 
        underbarrel: {
          name: 'Folding Stubby',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 14,
          replaced: [
            { name: 'ribbed vertical', pts: 20, type: 'Underbarrel', unlockLevel: 11 }
          ]
        },
        scope: {
          name: 'RO-M 1.75x',
          pts: 10,
          type: 'Scope',
          unlockLevel: 14
        }
      },
      17: {
        underbarrel: {
          name: 'Slim Angled',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 17,
          replaced: [
            { name: 'Folding Stubby', pts: 20, type: 'Underbarrel', unlockLevel: 14 }
          ]
        }
      },
      18: {
        ammunition: {
          name: 'hollow point',
          pts: 20,
          type: 'Ammunition',
          unlockLevel: 18,
          replaced: [
            { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 }
          ]
        }
      },
      19: {
        muzzle: {
          name: 'compensated brake',
          pts: 20,
          type: 'Muzzle',
          unlockLevel: 19,
          replaced: [
            { name: 'linear comp', pts: 10, type: 'Muzzle', unlockLevel: 8 }
          ]
        }
      },
      22: {
        ammunition: {
          name: 'FMJ',
          pts: 5,
          type: 'Ammunition',
          unlockLevel: 1,
          replaced: [
            { name: 'hollow point', pts: 20, type: 'Ammunition', unlockLevel: 18 }
          ]
        },
        leftAccessory: {
          name: 'FLASHLIGHT',
          pts: 10,
          type: 'Left Accessory',
          unlockLevel: 22
        }
      },
      23: {
        rightAccessory: {
          name: '50 MW GREEN',
          pts: 20,
          type: 'Right Accessory',
          unlockLevel: 23
        }
      },
      24: {
        muzzle: {
          name: 'standard suppressor',
          pts: 25,
          type: 'Muzzle',
          unlockLevel: 24,
          replaced: [
            { name: 'compensated brake', pts: 20, type: 'Muzzle', unlockLevel: 19 }
          ]
        }
      },
      26: {
        barrel: {
          name: '305mm Custom',
          pts: 15,
          type: 'Barrel',
          unlockLevel: 26,
          replaced: [
            { name: '200MM FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 }
          ]
        },
        // Keep: Barrel, Underbarrel  Ammunition  Muzzle  Right Magazine  Scope  
        leftAccessory: null
      },
      28: {
        muzzle: {
          name: 'long suppressor',
          pts: 25,
          type: 'Muzzle',
          unlockLevel: 28,
          replaced: [
            { name: 'standard suppressor', pts: 25, type: 'Muzzle', unlockLevel: 24 }
          ]
        }
      },
      29: {
        underbarrel: {
          name: 'Canted Stubby',
          pts: 30,
          type: 'Underbarrel',
          unlockLevel: 29,
          replaced: [
            { name: 'Slim Angled', pts: 25, type: 'Underbarrel', unlockLevel: 17 }
          ]
        },
        rightAccessory: {
          //unlocks at lv 12
          name: '5 MW GREEN',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 12,
          replaced: [
            { name: '50 MW GREEN', pts: 20, type: 'Right Accessory', unlockLevel: 23 }
          ]
        }
      },
      36: {
        underbarrel: {
          name: 'Stippled Stubby',
          pts: 35,
          type: 'Underbarrel',
          unlockLevel: 36,
          replaced: [
            { name: 'Canted Stubby', pts: 30, type: 'Underbarrel', unlockLevel: 29 }
          ]
        },
        // Keep: Barrel, Underbarrel, Ammunition, Muzzle, Magazine, Scope
        rightAccessory: null
      },
      37: {
        muzzle: {
          name: 'lightened suppressor',
          pts: 30,
          type: 'Muzzle',
          unlockLevel: 37,
          replaced: [
            { name: 'long suppressor', pts: 25, type: 'Muzzle', unlockLevel: 28 }
          ]
        }
      },
      39: {
        underbarrel: { // unlocked at 17
          name: 'Slim Angled',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 17,
          replaced: [
            { name: 'Stippled Stubby', pts: 35, type: 'Underbarrel', unlockLevel: 36 }
          ]
        },
        ammunition: {
          name: 'synthetic tip',
          pts: 30,
          type: 'Ammunition',
          unlockLevel: 39,
          replaced: [
            { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 }
          ]
        },
        muzzle: {
          name: 'Standard Suppressor',
          pts: 20,
          type: 'Muzzle',
          unlockLevel: 39,
          replaced: [
            { name: 'lightened suppressor', pts: 30, type: 'Muzzle', unlockLevel: 37 }
          ]
        }
      }
    };
    const qbz_192_baseline = {
      barrel: { name: '10.5" FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 },
      underbarrel: { name: 'FOLDING VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 1 },
      ammunition: { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 },
      ergonomics: { name: 'RAIL COVER', pts: 5, type: 'Ergonomics', unlockLevel: 'Season 1 Hardware 2' },
      magazine: { name: '36RND MAGAZINE', pts: 15, type: 'Magazine', unlockLevel: 1 },
      scope: { name: 'CCO 2.00X', pts: 10, type: 'Scope', unlockLevel: 1 }
    };
    const qbz_192_changes = {
      2: {
        muzzle: {
          name: 'linear comp',
         pts: 10,
          type: 'Muzzle',
          unlockLevel: 2
        }
      },
      3: {
        underbarrel: {
          name: 'alloy vertical',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 3,
          replaced: [
            { name: 'FOLDING VERTICAL', pts: 10, type: 'Underbarrel', unlockLevel: 1 }
          ]
        },
        scope: {
          name: 'RO-M 1.75x',
          pts: 10,
          type: 'Scope',
          unlockLevel: 3,
          replaced: [
            { name: 'CCO 2.00X', pts: 10, type: 'Scope', unlockLevel: 1 }
          ]
        }
      },
      5: {
        topAccessory: {
          name: '5 MW RED',
          pts: 10,
          type: 'Top Accessory',
          unlockLevel: 5
        }
      },
      6: {
        underbarrel: {
          name: 'ribbed vertical',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 6,
          replaced: [
            { name: 'alloy vertical', pts: 20, type: 'Underbarrel', unlockLevel: 3 }
          ]
        }
      },
      8: {
        rightAccessory: {
          name: 'flashlight',
          pts: 10,
          type: 'Right Accessory',
          unlockLevel: 8
        }
      },
      9: {
        underbarrel: {
          name: 'Folding Stubby',
          pts: 20,
          type: 'Underbarrel',
          unlockLevel: 9,
          replaced: [
            { name: 'ribbed vertical', pts: 20, type: 'Underbarrel', unlockLevel: 6 }
          ]
        }
      }, 
      12: {
        topAccessory: {
          name: '5 MW GREEN',
          pts: 10,
          type: 'Top Accessory',
          unlockLevel: 12,
          replaced: [
            { name: '5 MW RED', pts: 10, type: 'Top Accessory', unlockLevel: 5 }
          ]
        }
      },
      14: {
        ammunition: {
          name: 'Polymer Case',
          pts: 10,
          type: 'Ammunition',
          unlockLevel: 14,
          replaced: [
            { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 }
          ]
        }
      },
      16: {
        barrel: {
          name: '14.5" Common',
          pts: 10,
          type: 'Barrel',
          unlockLevel: 16,
          replaced: [
            { name: '10.5" FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 }
          ]
        },
        // Keep: Barrel, Underbarrel, Ammunition, Muzzle, Top Accessory, Ergonomics, Magazine, Scope
        rightAccessory: null
      },
      18: {
        underbarrel: {
          name: 'Slim Angled',
          pts: 25,
          type: 'Underbarrel',
          unlockLevel: 18,
          replaced: [
            { name: 'Folding Stubby', pts: 20, type: 'Underbarrel', unlockLevel: 9 }
          ]
        }
      },
      23: {
        underbarrel: {
          name: 'Canted Stubby',
          pts: 30,
          type: 'Underbarrel',
          unlockLevel: 23,
          replaced: [
            { name: 'Slim Angled', pts: 25, type: 'Underbarrel', unlockLevel: 18 }
          ]
        },
        ammunition: {
          name: 'FMJ',
          pts: 5,
          type: 'Ammunition',
          unlockLevel: 1,
          replaced: [
            { name: 'Polymer Case', pts: 10, type: 'Ammunition', unlockLevel: 14 }
          ]
        }
      },
      25: {
        underbarrel: {
          name: 'Full Angled',
          pts: 25,
          type: 'Underbarrel',
          unlockLevel: 25,
          replaced: [
            { name: 'Canted Stubby', pts: 30, type: 'Underbarrel', unlockLevel: 23 }
          ]
        },
        ammunition: {
          name: 'Polymer Case',
          pts: 10,
          type: 'Ammunition',
          unlockLevel: 1,
          replaced: [
            { name: 'FMJ', pts: 5, type: 'Ammunition', unlockLevel: 1 }
          ]
        }
      },
      36: {
        underbarrel: {
          name: 'Stipped Stubby',
          pts: 35,
          type: 'Underbarrel',
          unlockLevel: 36,
          replaced: [
            { name: 'Full Angled', pts: 25, type: 'Underbarrel', unlockLevel: 25 }
          ]
        },
        // Keep: Barrel, Underbarrel, Ammunition, Muzzle, Ergonomics, Magazine, Scope
        topAccessory: null
      },
      39: {
        underbarrel: {
          name: 'Low-Profile Stubby',
          pts: 45,
          type: 'Underbarrel',
          unlockLevel: 39,
          replaced: [
            { name: 'Stipped Stubby', pts: 35, type: 'Underbarrel', unlockLevel: 36 }
          ]
        },
        ammunition: {
          name: 'FMJ',
          pts: 5,
          type: 'Ammunition',
          unlockLevel: 1,
          replaced: [
            { name: 'Polymer Case', pts: 10, type: 'Ammunition', unlockLevel: 14 }
          ]
        },
        // Keep: Barrel, Underbarrel, Muzzle, Magazine, Scope.
        ergonomics: null
      }
    };
    // Optional: per-weapon Recommended Build
    // Add `recommended` to any weapon config as either an array or object.
    // Example:
    // recommended: [
    //   { name: 'A-P2 1.75X', type: 'Optic', unlockLevel: 17 },
    //   { name: 'LONG SUPPRESSOR', type: 'Muzzle', unlockLevel: 27 },
    //   { name: '590MM FACTORY', type: 'Barrel', unlockLevel: 1 },
    //   { name: 'FOLDING STUBBY', type: 'Underbarrel', unlockLevel: 9 },
    //   { name: '40RND MAGAZINE', type: 'Magazine', unlockLevel: 6 },
    //   { name: 'SYNTHETIC TIP', type: 'Ammunition', unlockLevel: 38 }
    // ]
    const weaponConfigs = [
      {
        id: 'kord-6p67',
        name: 'KORD 6P67',
        type: 'Assault Rifle',
        image: 'kord.avif',
        rank: 'm',
        tr: '1',
        minLevel: 1,
        maxLevel: 40,
        apMax: 100,
        slotOrder: ['1', '2', '3', '4', '5', '6', '7'],
        slotLabels: {
          '1': 'Barrel',
          '2': 'Underbarrel',
          '3': 'Ammunition',
          '4': 'Muzzle',
          '5': 'Right Accessory',
          '6': 'Magazine',
          '7': 'Scope'
        },
        baseline: KORD_BASELINE,
        changes: KORD_CHANGES
      },
      {
        id: 'pw5a3',
        name: 'PW5A3',
        type: 'SMG',
        image: 'pw5a3.avif',
        rank: 'm',
        tr: '1',
        minLevel: 1,
        maxLevel: 40,
        apMax: 100,
        slotOrder: ['barrel', 'underbarrel', 'ammunition', 'muzzle', 'magazine', 'ergonomics', 'scope'],
        slotLabels: {
          barrel: 'Barrel',
          underbarrel: 'Underbarrel',
          ammunition: 'Ammunition',
          muzzle: 'Muzzle',
          magazine: 'Magazine',
          ergonomics: 'Ergonomics',
          scope: 'Scope'
        },
        baseline: PW5A3_BASELINE,
        changes: PW5A3_CHANGES
      },
      {
        id: 'rpkm',
        name: 'RPKM - currently wrong attachments',
        type: 'LMG',
        image: 'rpkm.avif',
        rank: 'm',
        tr: '1',
        minLevel: 1,
        maxLevel: 40,
        apMax: 100,
        recommended: [
          { name: 'A-P2 1.75X', pts: 10, type: 'Optic', unlockLevel: 17 },
          { name: 'LONG SUPPRESSOR', pts: 25, type: 'Muzzle', unlockLevel: 27 },
          { name: '590MM FACTORY', pts: 10, type: 'Barrel', unlockLevel: 1 },
          { name: 'FOLDING STUBBY', pts: 20, type: 'Underbarrel', unlockLevel: 9 },
          { name: '40RND MAGAZINE', pts: 5, type: 'Magazine', unlockLevel: 1 },
          { name: 'SYNTHETIC TIP', pts: 30, type: 'Ammunition', unlockLevel: 38 }
        ],
        slotOrder: ['barrel', 'underbarrel', 'ammunition', 'muzzle', 'magazine', 'scope', 'leftAccessory', 'rightAccessory'],
        slotLabels: {
          barrel: 'Barrel',
          underbarrel: 'Underbarrel',
          ammunition: 'Ammunition',
          muzzle: 'Muzzle',
          magazine: 'Magazine',
          scope: 'Scope',
          leftAccessory: 'Left Accessory',
          rightAccessory: 'Right Accessory'
        },
        baseline: RPKM_BASELINE,
        changes: RPKM_CHANGES
      },
      {
        id: 'm87a1',
        name: 'M87A1',
        type: 'Shotgun',
        image: 'm87a1.avif',
        rank: 'm',
        tr: '1',
        minLevel: 1,
        maxLevel: 40,
        apMax: 100,
        slotOrder: ['barrel', 'ammunition', 'magazine', 'scope', 'underbarrel', 'muzzle', 'leftAccessory', 'rightAccessory'],
        slotLabels: {
          barrel: 'Barrel',
          ammunition: 'Ammunition',
          magazine: 'Magazine',
          scope: 'Scope',
          underbarrel: 'Underbarrel',
          muzzle: 'Muzzle',
          leftAccessory: 'Left Accessory',
          rightAccessory: 'Right Accessory'
        },
        baseline: M87A1_BASELINE,
        changes: M87A1_CHANGES
      },
      {
        id: 'ggh-22',
        name: 'GGH-22',
        type: 'Secondary',
        image: 'ggh-22.avif',
        rank: 'b',
        tr: '1',
        minLevel: 1,
        maxLevel: 40,
        apMax: 60,
        slotOrder: ['barrel', 'underbarrel', 'ammunition', 'magazine', 'scope', 'ergonomics', 'muzzle'],
        slotLabels: {
          barrel: 'Barrel',
          underbarrel: 'Underbarrel',
          ammunition: 'Ammunition',
          magazine: 'Magazine',
          scope: 'Scope',
          ergonomics: 'Ergonomics',
          muzzle: 'Muzzle'
        },
        baseline: GGH_22_BASELINE,
        changes: GGH_22_CHANGES
      },
      {
        id: 'l110',
        name: 'L110',
        type: 'LMG',
        image: 'l110.avif',
        rank: 'm',
        tr: '2',
        minLevel: 1,
        maxLevel: 40,
        apMax: 100,
        slotOrder: ['barrel', 'underbarrel', 'ammunition', 'muzzle', 'rightAccessory', 'magazine', 'scope', 'leftAccessory', 'ergonomics'],
        slotLabels: {
          barrel: 'Barrel',
          underbarrel: 'Underbarrel',
          ammunition: 'Ammunition',
          muzzle: 'Muzzle',
          rightAccessory: 'Right Accessory',
          magazine: 'Magazine',
          scope: 'Scope',
          leftAccessory: 'Left Accessory',
          ergonomics: 'Ergonomics'
        },
        baseline: L110_BASELINE,
        changes: L110_CHANGES
      },
      {
        id: 'm2010esr',
        name: 'M2010 ESR',
        type: 'Sniper Rifle',
        image: 'm2010-esr.avif',
        rank: 'm',
        tr: '1',
        minLevel: 1,
        maxLevel: 40,
        apMax: 100,
        slotOrder: ['barrel', 'underbarrel', 'ammunition', 'magazine', 'scope', 'leftAccessory', 'topAccessory', 'opticAccessory'],
        slotLabels: {
          barrel: 'Barrel',
          underbarrel: 'Underbarrel',
          ammunition: 'Ammunition',
          magazine: 'Magazine',
          scope: 'Scope',
          leftAccessory: 'Left Accessory',
          topAccessory: 'Top Accessory',
          opticAccessory: 'Optic Accessory'
        },
        baseline: m2010ESR_BASELINE,
        changes: M2010ESR_CHANGES
      },
      {
        id: 'miniscout',
        name: 'Mini Scout',
        type: 'Sniper Rifle',
        image: 'miniscout.avif',
        rank: 'm',
        tr: '2',
        minLevel: 1,
        maxLevel: 40,
        apMax: 100,
        slotOrder: ['barrel', 'underbarrel', 'ammunition', 'muzzle', 'magazine', 'scope', 'leftAccessory', 'rightAccessory', 'opticAccessory'],
        slotLabels: {
          barrel: 'Barrel',
          underbarrel: 'Underbarrel',
          ammunition: 'Ammunition',
          muzzle: 'Muzzle',
          magazine: 'Magazine',
          scope: 'Scope',
          leftAccessory: 'Left Accessory',
          rightAccessory: 'Right Accessory',
          opticAccessory: 'Optic Accessory'
        },
        baseline: miniscout_baseline,
        changes: miniscout_changes
      },
      {
        id: 'umg40',
        name: 'UMG-40',
        type: 'SMG',
        image: 'umg-40.avif',
        rank: 'm',
        tr: '2',
        minLevel: 1,
        maxLevel: 40,
        apMax: 100,
        slotOrder: ['barrel', 'underbarrel', 'ammunition', 'muzzle', 'magazine', 'scope', 'leftAccessory', 'rightAccessory'],
        slotLabels: {
          barrel: 'Barrel',
          underbarrel: 'Underbarrel',
          ammunition: 'Ammunition',
          muzzle: 'Muzzle',
          magazine: 'Magazine',
          scope: 'Scope',
          leftAccessory: 'Left Accessory',
          rightAccessory: 'Right Accessory'
        },
        baseline: umg40_baseline,
        changes: umg40_changes
      },
      {
        id: 'qbz-192',
        name: 'QBZ-192',
        type: 'Carbine',
        image: 'qbz-192.avif',
        rank: 'm',
        tr: '1',
        minLevel: 1,
        maxLevel: 40,
        apMax: 100,
        slotOrder: ['barrel', 'underbarrel', 'ammunition', 'muzzle', 'topAccessory', 'ergonomics', 'magazine', 'scope'],
        slotLabels: {
          barrel: 'Barrel',
          underbarrel: 'Underbarrel',
          ammunition: 'Ammunition',
          muzzle: 'Muzzle',
          topAccessory: 'Top Accessory',
          ergonomics: 'Ergonomics',
          magazine: 'Magazine',
          scope: 'Scope'
        },
        baseline: qbz_192_baseline,
        changes: qbz_192_changes
      }
    ];

    const template = document.getElementById('weaponTemplate');
    const weaponListEl = document.getElementById('weaponList');
    const weaponNavEl = document.getElementById('weaponNav');
    function alignSideNav() {
  const nav = document.getElementById('weaponNav');
  const app = document.querySelector('.app');
  if (!nav || !app) return;
  const style = window.getComputedStyle(nav);
  if (style.display === 'none') return;
  const appRect = app.getBoundingClientRect();
  const navWidth = nav.offsetWidth || 240;
  const gap = 24;
  const scrollX = window.pageXOffset || document.documentElement.scrollLeft || 0;
  let left = Math.round(appRect.left + scrollX - navWidth - gap);
  if (left < 8) left = 8;
  nav.style.left = left + 'px';

  const header = document.querySelector('.page-header');
  if (header) {
    const headerRect = header.getBoundingClientRect();
    const top = Math.max(16, Math.round(headerRect.bottom + 12));
    nav.style.top = top + 'px';
  } else {
    nav.style.top = '96px';
  }
}
    

    const trackers = weaponConfigs.map((config) => {
      const tracker = new WeaponTracker(config);
      tracker.mount(template);
      return tracker;
    });

    function updateWeaponNav(order) {
      if (!weaponNavEl) return;
      const idToTracker = new Map(trackers.map((t) => [t.id, t]));
      const ul = document.createElement('ul');
      ul.className = 'side-nav-list';
      for (const id of order) {
        const tracker = idToTracker.get(id);
        if (!tracker) continue;
        const li = document.createElement('li');
        li.className = 'side-nav-item';
        li.dataset.weaponId = id;
        const name = document.createElement('span');
        name.className = 'side-nav-name';
        name.textContent = toUpperSafe(tracker.config.name || id);
        li.appendChild(name);
        if (tracker.config && tracker.config.type) {
          const type = document.createElement('span');
          type.className = 'side-nav-type';
          type.textContent = toUpperSafe(tracker.config.type);
          li.appendChild(type);
        }
        if (tracker.isFavorite()) {
          const fav = document.createElement('span');
          fav.className = 'side-nav-fav';
          fav.setAttribute('aria-hidden', 'true');
          fav.textContent = '\u2605';
          li.appendChild(fav);
        }
        ul.appendChild(li);
      }
      weaponNavEl.innerHTML = '';
      weaponNavEl.appendChild(ul);
      weaponNavEl.classList.add("nav-ready");
      alignSideNav();
    }

    function scrollToTracker(tracker) {
      if (!tracker || !tracker.cardEl) return;
      const rect = tracker.cardEl.getBoundingClientRect();
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const viewportH = window.innerHeight || document.documentElement.clientHeight;
      let targetTop;
      if (!tracker.state.collapsed) {
        const mid = rect.top + scrollTop + rect.height / 2;
        targetTop = Math.max(0, Math.round(mid - viewportH / 2));
      } else {
        targetTop = Math.max(0, Math.round(rect.top + scrollTop - 24));
      }
      window.scrollTo({ top: targetTop, behavior: 'smooth' });
    }

    if (weaponNavEl) {
      weaponNavEl.addEventListener('click', (event) => {
        const item = event.target.closest('.side-nav-item');
        if (!item) return;
        const id = item.dataset.weaponId;
        const tracker = trackers.find((t) => t.id === id);
        scrollToTracker(tracker);
      });
    }

    function renderWeaponList() {
      const storedOrder = storage.getOrder();
      const idToTracker = new Map(trackers.map((tracker) => [tracker.id, tracker]));
      const baseOrder = [];
      const seen = new Set();

      for (const id of storedOrder) {
        if (idToTracker.has(id) && !seen.has(id)) {
          baseOrder.push(id);
          seen.add(id);
        }
      }

      for (const tracker of trackers) {
        if (!seen.has(tracker.id)) {
          baseOrder.push(tracker.id);
          seen.add(tracker.id);
        }
      }

      const favorites = baseOrder.filter((id) => idToTracker.get(id).isFavorite());
      const others = baseOrder.filter((id) => !idToTracker.get(id).isFavorite());
      const finalOrder = favorites.concat(others);

      const storedMatches =
        storedOrder.length === finalOrder.length &&
        finalOrder.every((id, index) => storedOrder[index] === id);
      if (!storedMatches) {
        storage.setOrder(finalOrder);
      }

      weaponListEl.innerHTML = '';
      for (const id of finalOrder) {
        const tracker = idToTracker.get(id);
        tracker.attach(weaponListEl);
      }
      updateWeaponNav(finalOrder);
    }

    renderWeaponList();
    alignSideNav();

    weaponListEl.addEventListener('dragover', (event) => {
      if (!currentDraggedId) return;
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
    });

    weaponListEl.addEventListener('drop', (event) => {
      if (!currentDraggedId) return;
      event.preventDefault();
      const dropCard = event.target.closest('.weapon-card');
      const domOrder = Array.from(weaponListEl.children).map((el) => el.dataset.weaponId);
      let insertIndex = domOrder.length;
      if (dropCard) {
        const dropId = dropCard.dataset.weaponId;
        const dropIndex = domOrder.indexOf(dropId);
        if (dropIndex !== -1) {
          const rect = dropCard.getBoundingClientRect();
          const before = event.clientY < rect.top + rect.height / 2;
          insertIndex = before ? dropIndex : dropIndex + 1;
        }
      }

      const order = domOrder.filter((id) => id && id !== currentDraggedId);
      if (insertIndex > order.length) {
        insertIndex = order.length;
      }
      order.splice(insertIndex, 0, currentDraggedId);
      storage.setOrder(order);
      renderWeaponList();
    alignSideNav();
      currentDraggedId = null;
    });

    window.addEventListener('resize', () => {
      trackers.forEach((tracker) => tracker.refreshLayout());
      alignSideNav();
    });

    // UI Scale control setup
    (function setupUiScale() {
      const KEY = 'bf6-meta-ui-scale';
      const valueEl = document.getElementById('uiScaleValue');
      const progressEl = document.getElementById('uiScaleProgress');
      const knobEl = progressEl ? progressEl.querySelector('.knob') : null;

      const MIN = 50;
      const MAX = 200;
      const STEP = 5;
      const STEPS = Math.floor((MAX - MIN) / STEP) + 1; // 31

      function clampPercent(p) {
        p = Math.round(Number(p) || 100);
        if (p < MIN) p = MIN;
        if (p > MAX) p = MAX;
        return p;
      }

      function quantize(p) {
        const clamped = clampPercent(p);
        const stepsFromMin = Math.round((clamped - MIN) / STEP);
        return MIN + stepsFromMin * STEP;
      }

      function ensureSegments() {
        if (!progressEl) return;
        const existing = progressEl.querySelectorAll('.segment').length;
        if (existing === STEPS) return;
        progressEl.querySelectorAll('.segment').forEach((s) => s.remove());
        const frag = document.createDocumentFragment();
        for (let i = 0; i < STEPS; i++) {
          const seg = document.createElement('div');
          seg.className = 'segment';
          frag.appendChild(seg);
        }
        progressEl.insertBefore(frag, knobEl);
        progressEl.style.setProperty('--max-level', String(STEPS));
      }

      function updateUI(pct) {
        if (!progressEl || !knobEl) return;
        ensureSegments();
        const value = quantize(pct);
        const percent = ((value - MIN) / (MAX - MIN)) * 100;
        knobEl.style.left = percent + '%';
        progressEl.setAttribute('aria-valuenow', String(value));
        const idx = Math.round((value - MIN) / STEP);
        const segments = progressEl.querySelectorAll('.segment');
        segments.forEach((seg, i) => {
          if (i <= idx) seg.classList.add('active');
          else seg.classList.remove('active');
        });
        if (valueEl) valueEl.textContent = value + '%';
      }

      function applyScale(percent) {
        const p = quantize(percent);
        document.documentElement.style.setProperty('--ui-scale', (p / 100).toString());
        document.documentElement.style.setProperty('--ui-scale-pct', p + '%');
        try { localStorage.setItem(KEY, String(p)); } catch (_) {}
        updateUI(p);
        alignSideNav();
      }

      function valueFromClientX(clientX) {
        const rect = progressEl.getBoundingClientRect();
        let ratio = (clientX - rect.left) / rect.width;
        if (ratio < 0) ratio = 0; if (ratio > 1) ratio = 1;
        const raw = MIN + ratio * (MAX - MIN);
        return quantize(raw);
      }

      let initial = 100;
      try {
        const raw = localStorage.getItem(KEY);
        const num = parseInt(raw || '100', 10);
        if (Number.isFinite(num)) initial = clampPercent(num);
      } catch (_) {}

      if (progressEl) {
        progressEl.setAttribute('aria-valuemin', String(MIN));
        progressEl.setAttribute('aria-valuemax', String(MAX));
        ensureSegments();
        progressEl.addEventListener('click', (e) => {
          applyScale(valueFromClientX(e.clientX));
        });
        let scrubbing = false;
        let pointerId = null;
        const onMove = (e) => {
          if (!scrubbing) return;
          applyScale(valueFromClientX(e.clientX));
        };
        const onEnd = (e) => {
          if (!scrubbing) return;
          scrubbing = false;
          try { if (pointerId != null) progressEl.releasePointerCapture(pointerId); } catch (_) {}
          pointerId = null;
          progressEl.removeEventListener('pointermove', onMove);
        };
        progressEl.addEventListener('pointerdown', (e) => {
          scrubbing = true;
          pointerId = e.pointerId;
          try { progressEl.setPointerCapture(pointerId); } catch (_) {}
          progressEl.addEventListener('pointermove', onMove);
          progressEl.addEventListener('pointerup', onEnd, { once: true });
          progressEl.addEventListener('pointercancel', onEnd, { once: true });
          applyScale(valueFromClientX(e.clientX));
        });
        progressEl.tabIndex = 0;
        progressEl.addEventListener('keydown', (e) => {
          const now = parseInt(progressEl.getAttribute('aria-valuenow') || String(initial), 10);
          let next = now;
          if (e.key === 'ArrowRight' || e.key === 'ArrowUp') next = now + STEP;
          else if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') next = now - STEP;
          else if (e.key === 'PageUp') next = now + STEP * 2;
          else if (e.key === 'PageDown') next = now - STEP * 2;
          else if (e.key === 'Home') next = MIN;
          else if (e.key === 'End') next = MAX;
          if (next !== now) {
            e.preventDefault();
            applyScale(next);
          }
        });
      }

      applyScale(initial);
    })();
  </script>
</body>
</html>
















































    
